<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人財務管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #1a202c; /* 深色背景，類似你的截圖 */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .auth-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            margin: 50px auto;
        }
        .auth-icon {
            background-color: #e2e8f0;
            color: #4299e1;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 20px;
        }
        .form-control {
            border-radius: 8px;
            padding: 10px 15px;
        }
        .btn-primary {
            background-color: #10b981; /* 綠色按鈕 */
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-weight: bold;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #059669;
        }
        .toggle-link {
            text-align: center;
            margin-top: 15px;
            color: #718096;
            cursor: pointer;
        }
        .toggle-link span {
            color: #3182ce;
        }
        
        /* Dashboard 樣式 */
        #dashboard-section {
            display: none;
            padding: 20px;
        }
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-box {
            background: #ebf8ff;
            border-left: 5px solid #4299e1;
            padding: 15px;
            border-radius: 4px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="register-section" class="container">
        <div class="auth-card">
            <div class="auth-icon"><i class="fas fa-wallet"></i></div>
            <h3 class="text-center mb-4">註冊新帳號</h3>
            <form id="register-form">
                <div class="mb-3">
                    <label class="form-label">姓名 (Name)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" id="reg-name" class="form-control" placeholder="您的姓名" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">帳號 (Email)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="far fa-envelope"></i></span>
                        <input type="email" id="reg-email" class="form-control" placeholder="name@example.com" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">密碼</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" id="reg-password" class="form-control" placeholder="********" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">確認密碼</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" id="reg-confirm-password" class="form-control" placeholder="再次輸入密碼" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">立即註冊</button>
            </form>
            <div class="toggle-link" onclick="showLogin()">
                已經有帳號了嗎？ <span>直接登入</span>
            </div>
        </div>
    </div>

    <div id="login-section" class="container hidden">
        <div class="auth-card">
            <div class="auth-icon"><i class="fas fa-sign-in-alt"></i></div>
            <h3 class="text-center mb-4">登入系統</h3>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">帳號 (Email)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="far fa-envelope"></i></span>
                        <input type="email" id="login-email" class="form-control" placeholder="name@example.com" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">密碼</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" id="login-password" class="form-control" placeholder="********" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">登入</button>
            </form>
            <div class="toggle-link" onclick="showRegister()">
                還沒有帳號？ <span>註冊新帳號</span>
            </div>
        </div>
    </div>

    <div id="dashboard-section" class="container-fluid">
        <nav class="navbar navbar-light bg-light rounded mb-3 px-3">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-chart-line"></i> 財務管理系統</span>
            <div class="d-flex align-items-center">
                <span id="user-display-name" class="me-3 fw-bold"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">登出</button>
            </div>
        </nav>

        <div class="row">
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h4><i class="fas fa-plus-circle"></i> 新增支出/收入</h4>
                    <hr>
                    <form id="add-record-form">
                        <div class="mb-2">
                            <label>日期</label>
                            <input type="date" id="record-date" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>時間</label>
                            <input type="time" id="record-time" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>項目說明</label>
                            <input type="text" id="record-item" class="form-control" placeholder="例如：午餐" required>
                        </div>
                        <div class="mb-3">
                            <label>金額 (支出為負，收入為正)</label>
                            <input type="number" id="record-amount" class="form-control" placeholder="例如：-100" required>
                        </div>
                        <button type="submit" class="btn btn-primary">儲存紀錄</button>
                    </form>
                </div>
            </div>

            <div class="col-md-8">
                <div class="dashboard-card">
                    <h4><i class="fas fa-search"></i> 查詢與統計</h4>
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-md-3">
                            <label>開始日期</label>
                            <input type="date" id="query-start" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label>結束日期</label>
                            <input type="date" id="query-end" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label>顯示模式</label>
                            <select id="view-mode" class="form-select">
                                <option value="detail">顯示明細 & 總和</option>
                                <option value="summary">只顯示總金額</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button onclick="queryRecords()" class="btn btn-secondary w-100">查詢</button>
                        </div>
                    </div>
                    
                    <div class="summary-box mb-3">
                        <h5>區間總金額: <span id="total-amount" class="fw-bold text-dark">$0</span></h5>
                    </div>

                    <div id="list-container" class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>時間</th>
                                    <th>項目</th>
                                    <th class="text-end">金額</th>
                                </tr>
                            </thead>
                            <tbody id="records-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        // CONFIG: 請在此處填入你的 Firebase 設定
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // --- UI 切換邏輯 ---
        window.showLogin = () => {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
        };
        window.showRegister = () => {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.remove('hidden');
        };

        // --- 1. 註冊功能 ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPwd = document.getElementById('reg-confirm-password').value;

            if (password !== confirmPwd) {
                alert("兩次密碼輸入不一致！");
                return;
            }

            try {
                // 建立 Auth 帳號
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 將使用者姓名寫入 Firestore (users 集合，使用 uid 當 key)
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    createdAt: new Date()
                });

                alert("註冊成功！請登入。");
                showLogin();
            } catch (error) {
                console.error(error);
                alert("註冊失敗: " + error.message);
            }
        });

        // --- 2. 登入功能 ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // 登入成功後，onAuthStateChanged 會自動處理畫面切換
            } catch (error) {
                alert("登入失敗: " + error.message);
            }
        });

        // --- 3. 登出功能 ---
        window.logout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // --- 監聽登入狀態 ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('register-section').classList.add('hidden');
                document.getElementById('dashboard-section').style.display = 'block';
                
                // 設定預設日期 (今天)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('record-date').value = today;
                
                // 設定預設時間
                const now = new Date();
                const timeString = now.toTimeString().split(' ')[0].substring(0,5);
                document.getElementById('record-time').value = timeString;

                // 預設查詢當月
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                document.getElementById('query-start').value = firstDay;
                document.getElementById('query-end').value = today;

                document.getElementById('user-display-name').innerText = user.email; // 或從 DB 讀取名字
                queryRecords(); // 載入資料
            } else {
                currentUser = null;
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('register-section').classList.remove('hidden'); // 預設顯示註冊
            }
        });

        // --- 4. 新增記帳紀錄 ---
        document.getElementById('add-record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const date = document.getElementById('record-date').value;
            const time = document.getElementById('record-time').value;
            const item = document.getElementById('record-item').value;
            const amount = parseFloat(document.getElementById('record-amount').value);

            try {
                // 資料結構：儲存在 users/{uid}/records 子集合中，確保隱私
                // 組合完整的 Date 物件以便排序
                const fullDateTime = new Date(`${date}T${time}`);

                await addDoc(collection(db, "users", currentUser.uid, "records"), {
                    date: date,
                    time: time,
                    item: item,
                    amount: amount,
                    timestamp: Timestamp.fromDate(fullDateTime) // 用於排序
                });

                alert("紀錄已新增！");
                document.getElementById('record-item').value = "";
                document.getElementById('record-amount').value = "";
                queryRecords(); // 重新整理列表
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("新增失敗");
            }
        });

        // --- 5. 查詢功能 ---
        window.queryRecords = async () => {
            if (!currentUser) return;

            const startDate = document.getElementById('query-start').value;
            const endDate = document.getElementById('query-end').value;
            const viewMode = document.getElementById('view-mode').value;
            const tbody = document.getElementById('records-tbody');
            const totalDisplay = document.getElementById('total-amount');

            tbody.innerHTML = '<tr><td colspan="4" class="text-center">載入中...</td></tr>';

            try {
                const recordsRef = collection(db, "users", currentUser.uid, "records");
                
                // 建立查詢條件：日期區間
                // 注意：字串比較 "2023-01-01" < "2023-01-02" 是有效的
                const q = query(
                    recordsRef, 
                    where("date", ">=", startDate),
                    where("date", "<=", endDate),
                    orderBy("date", "desc"),
                    orderBy("time", "desc")
                );

                const querySnapshot = await getDocs(q);
                
                let total = 0;
                let html = "";

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    total += data.amount;
                    
                    if (viewMode === 'detail') {
                        const amountClass = data.amount < 0 ? 'text-danger' : 'text-success';
                        html += `
                            <tr>
                                <td>${data.date}</td>
                                <td>${data.time}</td>
                                <td>${data.item}</td>
                                <td class="text-end ${amountClass}">${data.amount}</td>
                            </tr>
                        `;
                    }
                });

                if (querySnapshot.empty) {
                    html = '<tr><td colspan="4" class="text-center">此區間無資料</td></tr>';
                } else if (viewMode === 'summary') {
                    html = '<tr><td colspan="4" class="text-center text-muted">已隱藏明細，僅顯示總和</td></tr>';
                }

                tbody.innerHTML = html;
                totalDisplay.innerText = `$${total}`;
                totalDisplay.className = total < 0 ? 'fw-bold text-danger' : 'fw-bold text-success';

            } catch (error) {
                console.error("Query error: ", error);
                // 常見錯誤是需要建立 Firestore 索引，請查看 Console 的連結
                if(error.message.includes("requires an index")) {
                    alert("初次查詢可能需要建立索引，請按 F12 開啟 Console 點擊連結建立。");
                } else {
                    alert("查詢失敗，請檢查網路或日期格式。");
                }
            }
        };
    </script>
</body>
</html>