<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人財務管理系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定義動畫與樣式 */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <div id="app" class="min-h-screen">
        <!-- 載入中畫面 -->
        <div id="loading" class="min-h-screen flex items-center justify-center bg-gray-100 text-gray-500">
            <div class="animate-spin mr-2">
                <div class="h-6 w-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            </div>
            載入系統中...
        </div>

        <!-- 登入/註冊畫面 (預設隱藏) -->
        <div id="auth-view" class="hidden min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
            <!-- 內容由 JS 動態生成 -->
        </div>

        <!-- 主控台畫面 (預設隱藏) -->
        <div id="dashboard-view" class="hidden max-w-6xl mx-auto px-4 py-8 fade-in">
            <!-- 內容由 JS 動態生成 -->
        </div>
    </div>

    <!-- Firebase SDK (使用 Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            setDoc,
            getDoc,
            onSnapshot, 
            doc, 
            deleteDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. 設定與初始化 ---
        
        // 部署與預覽環境的 Config 處理
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // TODO: 部署到 GitHub Pages 時，請在此填入您的 Firebase Config
                apiKey: "AIzaSyDpihYUzRX09riiiP2gTm81KCR1pbVpFis",
                authDomain: "xmas-1654f.firebaseapp.com",
                projectId: "xmas-1654f",
                storageBucket: "xmas-1654f.firebasestorage.app",
                messagingSenderId: "171667807726",
                appId: "1:171667807726:web:639da18d4fb507734f02ff",
                measurementId: "G-3G4WYVDK4H"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'finance-tracker-vanilla';

        // --- 2. 應用程式狀態 (State) ---
        const state = {
            user: null,
            userName: '', // 新增：儲存從資料庫讀取的姓名
            transactions: [],
            authMode: 'login', // 'login' or 'register'
            filterType: 'month', // 'day', 'month', 'year', 'custom'
            viewMode: 'list', // 'list', 'summary'
            customStart: '',
            customEnd: '',
            loading: true
        };

        // --- 3. DOM 元素參考 ---
        const els = {
            loading: document.getElementById('loading'),
            authView: document.getElementById('auth-view'),
            dashboardView: document.getElementById('dashboard-view'),
        };

        // --- 4. 核心邏輯函式 ---

        // 初始化 Auth
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.error("Token login failed", e);
                }
            }
            
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                state.loading = false;
                
                if (user) {
                    // 登入後，同時監聽資料與使用者設定檔
                    subscribeToData();
                    subscribeToUserProfile();
                } else {
                    state.transactions = [];
                    state.userName = '';
                    unsubscribeAll();
                }
                renderApp();
            });
        }

        // 監聽使用者個人資料 (為了取得姓名)
        let unsubscribeUser = null;
        function subscribeToUserProfile() {
            if (unsubscribeUser) unsubscribeUser();
            
            const userDocRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
            unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.name) {
                        state.userName = data.name;
                        updateWelcomeMessage(); // 更新介面文字
                    }
                }
            });
        }

        // 監聽記帳資料
        let unsubscribeData = null;
        function subscribeToData() {
            if (unsubscribeData) unsubscribeData();

            const q = collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions');
            
            unsubscribeData = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // 前端排序
                data.sort((a, b) => {
                    if (b.date !== a.date) return b.date.localeCompare(a.date);
                    return b.time.localeCompare(a.time);
                });

                state.transactions = data;
                renderTransactionList();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        }

        function unsubscribeAll() {
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeData) unsubscribeData();
        }

        // 過濾資料邏輯
        function getFilteredTransactions() {
            const now = new Date();
            return state.transactions.filter(t => {
                const [y, m, d] = t.date.split('-').map(Number);
                const tDate = new Date(y, m - 1, d);
                
                if (state.filterType === 'day') {
                    return tDate.toDateString() === now.toDateString();
                } else if (state.filterType === 'month') {
                    return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                } else if (state.filterType === 'year') {
                    return tDate.getFullYear() === now.getFullYear();
                } else if (state.filterType === 'custom') {
                    if (!state.customStart || !state.customEnd) return true;
                    const start = new Date(state.customStart);
                    const end = new Date(state.customEnd);
                    start.setHours(0,0,0,0);
                    end.setHours(23,59,59,999);
                    return tDate >= start && tDate <= end;
                }
                return true;
            });
        }

        // --- 5. 渲染函式 (Render) ---

        function renderApp() {
            if (state.loading) {
                els.loading.classList.remove('hidden');
                els.authView.classList.add('hidden');
                els.dashboardView.classList.add('hidden');
                return;
            }

            els.loading.classList.add('hidden');

            if (state.user) {
                els.authView.classList.add('hidden');
                els.dashboardView.classList.remove('hidden');
                renderDashboard();
            } else {
                els.authView.classList.remove('hidden');
                els.dashboardView.classList.add('hidden');
                renderAuth();
            }
            lucide.createIcons();
        }

        // 輔助函式：只更新歡迎訊息，避免重繪整個 Dashboard
        function updateWelcomeMessage() {
            const el = document.getElementById('user-display-name');
            if (el) {
                // 優先顯示 DB 讀到的 userName，其次是 Auth 的 displayName，最後是預設值
                el.textContent = `嗨，${state.userName || state.user.displayName || '使用者'}`;
            }
        }

        function renderAuth() {
            const isRegister = state.authMode === 'register';
            els.authView.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 fade-in">
                    <div class="flex flex-col items-center mb-8">
                        <div class="bg-blue-100 p-4 rounded-full mb-4">
                            <i data-lucide="wallet" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">
                            ${isRegister ? '註冊新帳號' : '登入財務系統'}
                        </h2>
                        <p class="text-gray-500 text-sm mt-1">
                            ${isRegister ? '建立您的個人財務管理檔案' : '歡迎回來，請輸入您的帳號資訊'}
                        </p>
                    </div>

                    <form id="auth-form" class="space-y-5">
                        ${isRegister ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="user" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input type="text" name="name" required class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="王小明">
                            </div>
                        </div>` : ''}

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">帳號 (Email)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input type="email" name="email" required class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="name@example.com">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input type="password" name="password" required class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                            </div>
                        </div>

                        ${isRegister ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">確認密碼</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input type="password" name="confirmPassword" required class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="再次輸入密碼">
                            </div>
                        </div>` : ''}

                        <div id="auth-error" class="hidden text-red-500 text-sm text-center"></div>

                        <button type="submit" id="auth-submit-btn" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors">
                            ${isRegister ? '立即註冊' : '登入系統'}
                        </button>
                    </form>

                    <div class="mt-6 flex items-center justify-center space-x-2 text-sm">
                        <span class="text-gray-500">
                            ${isRegister ? '已經有帳號了嗎？' : '還沒有帳號嗎？'}
                        </span>
                        <button id="toggle-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">
                            ${isRegister ? '直接登入' : '註冊新帳號'}
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('toggle-auth-mode').addEventListener('click', () => {
                state.authMode = state.authMode === 'login' ? 'register' : 'login';
                renderApp();
            });

            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
        }

        function renderDashboard() {
            // 如果已經渲染過，只更新列表，不重繪整個 DOM 以免失去輸入焦點
            // 這裡直接重置 innerHTML 其實沒關係，因為只有在 filter 或 viewMode 改變時呼叫
            // 但為了確保輸入框體驗，我們通常會檢查
            
            // 這裡我們簡單處理：若已經有結構，就不重新賦值 innerHTML (除非是 init)
            // 但因為是 Vanilla JS 單檔，最簡單是每次都重繪。
            // 為了支援姓名更新，我們加上 ID 'user-display-name'
            
            const dashboardHTML = `
                <!-- Header -->
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <i data-lucide="user" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <div>
                            <h1 id="user-display-name" class="text-xl font-bold text-gray-800">
                                嗨，${state.userName || state.user.displayName || '使用者'}
                            </h1>
                            <p class="text-sm text-gray-500">歡迎使用您的個人財務系統</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="flex items-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                        登出
                    </button>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 左側：新增表單 -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-8">
                            <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                                <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-emerald-500"></i>
                                記一筆帳
                            </h2>
                            <form id="add-transaction-form" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">日期</label>
                                    <div class="relative">
                                        <i data-lucide="calendar" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                        <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">時間</label>
                                    <div class="relative">
                                        <i data-lucide="clock" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                        <input type="time" name="time" required value="${new Date().toTimeString().slice(0,5)}" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">項目名稱</label>
                                    <div class="relative">
                                        <i data-lucide="tag" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                        <input type="text" name="item" required placeholder="例如：午餐" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">金額</label>
                                    <div class="relative">
                                        <i data-lucide="dollar-sign" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                        <input type="number" name="amount" required min="0" placeholder="0" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-sm transition-all hover:shadow-md flex items-center justify-center">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> 新增支出
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- 右側：列表與查詢 -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- 過濾器 -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                                <div class="flex flex-wrap gap-2" id="filter-buttons">
                                    ${renderFilterButton('day', '今日')}
                                    ${renderFilterButton('month', '本月')}
                                    ${renderFilterButton('year', '今年')}
                                    ${renderFilterButton('custom', '自訂區間')}
                                </div>
                                <div class="flex items-center space-x-2 bg-gray-50 p-1 rounded-lg border border-gray-200">
                                    <button onclick="window.setViewMode('list')" class="p-2 rounded-md ${state.viewMode === 'list' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-400'}">
                                        <i data-lucide="list" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="window.setViewMode('summary')" class="p-2 rounded-md ${state.viewMode === 'summary' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-400'}">
                                        <i data-lucide="pie-chart" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- 自訂日期區塊 -->
                            <div id="custom-date-picker" class="${state.filterType === 'custom' ? 'flex' : 'hidden'} items-center gap-2 mb-6 bg-blue-50 p-3 rounded-lg animate-fade-in">
                                <input type="date" id="custom-start" value="${state.customStart}" class="border rounded px-2 py-1 text-sm">
                                <span class="text-gray-400">至</span>
                                <input type="date" id="custom-end" value="${state.customEnd}" class="border rounded px-2 py-1 text-sm">
                            </div>

                            <!-- 總金額 -->
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg flex justify-between items-center">
                                <div>
                                    <p class="text-blue-100 text-sm mb-1" id="total-label">總支出</p>
                                    <h3 class="text-3xl font-bold" id="total-amount">$ 0</h3>
                                </div>
                                <div class="bg-white/20 p-3 rounded-full backdrop-blur-sm">
                                    <i data-lucide="dollar-sign" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>

                        <!-- 列表容器 -->
                        <div id="transaction-list-container" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <!-- 內容由 renderTransactionList 填充 -->
                        </div>
                    </div>
                </div>
            `;
            
            // 為了不干擾輸入，我們只在結構不存在時才寫入，或是透過 state 變更強制重繪
            // 這裡為了簡單，我們採用替換 innerHTML 的方式，但加上檢查
            if (els.dashboardView.innerHTML.trim() === '') {
                els.dashboardView.innerHTML = dashboardHTML;
                bindDashboardEvents();
            } else {
                // 如果已經存在，我們只更新"變動"的部分嗎？
                // 在此專案中，切換 Filter 會呼叫 setFilterType -> renderDashboard
                // 這時候還是需要重繪，否則按鈕狀態不會變。
                // 所以我們這裡一律重繪。
                // 注意：如果正在打字時重繪，會失去焦點。但打字時不會觸發 renderDashboard (除了 updateUserName)
                
                // 但 updateUserName 我們已經用獨立函式處理了，所以這裡可以安心重繪 (切換 view/filter 時)
                // 唯一例外是：如果 "新增支出" 失敗重繪？不會，handleAddTransaction 只會 alert。
                
                // 所以結論：除了 updateWelcomeMessage 之外，其他狀態改變都重繪是安全的。
                // 我們只在第一次渲染時綁定事件
                const isFirstRender = els.dashboardView.innerHTML.trim() === '';
                els.dashboardView.innerHTML = dashboardHTML;
                bindDashboardEvents();
            }

            renderTransactionList();
        }

        function bindDashboardEvents() {
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('add-transaction-form').addEventListener('submit', handleAddTransaction);
            
            const startInput = document.getElementById('custom-start');
            const endInput = document.getElementById('custom-end');
            if(startInput && endInput) {
                startInput.addEventListener('change', (e) => { state.customStart = e.target.value; renderTransactionList(); });
                endInput.addEventListener('change', (e) => { state.customEnd = e.target.value; renderTransactionList(); });
            }
        }

        function renderFilterButton(type, label) {
            const isActive = state.filterType === type;
            return `
                <button onclick="window.setFilterType('${type}')" class="px-3 py-1.5 text-sm rounded-full transition-colors ${isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                    ${label}
                </button>
            `;
        }

        function renderTransactionList() {
            const container = document.getElementById('transaction-list-container');
            const totalAmountEl = document.getElementById('total-amount');
            const totalLabelEl = document.getElementById('total-label');
            
            if (!container) return;

            const filtered = getFilteredTransactions();
            const total = filtered.reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

            if (totalAmountEl) totalAmountEl.textContent = `$ ${total.toLocaleString()}`;
            if (totalLabelEl) {
                const labels = { day: '今日支出', month: '本月支出', year: '年度支出', custom: '區間總計' };
                totalLabelEl.textContent = labels[state.filterType];
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center flex flex-col items-center text-gray-400">
                        <i data-lucide="filter" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p>此區間沒有支出紀錄</p>
                    </div>
                `;
            } else if (state.viewMode === 'list') {
                container.innerHTML = `
                    <div class="divide-y divide-gray-100">
                        ${filtered.map(t => `
                            <div class="p-4 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                <div class="flex items-start gap-4">
                                    <div class="bg-emerald-100 text-emerald-600 p-2.5 rounded-lg">
                                        <i data-lucide="tag" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">${t.item}</h4>
                                        <div class="flex items-center text-xs text-gray-500 mt-1 space-x-3">
                                            <span class="flex items-center"><i data-lucide="calendar" class="w-3 h-3 mr-1"></i> ${t.date}</span>
                                            <span class="flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i> ${t.time}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-bold text-gray-800 text-lg">- ${Number(t.amount).toLocaleString()}</span>
                                    <button onclick="window.deleteTransaction('${t.id}')" class="text-gray-300 hover:text-red-500 transition-colors p-2">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                const summary = {};
                filtered.forEach(t => {
                    const amt = Number(t.amount);
                    summary[t.item] = (summary[t.item] || 0) + amt;
                });
                const sortedSummary = Object.entries(summary).sort((a, b) => b[1] - a[1]);
                const maxVal = sortedSummary.length > 0 ? sortedSummary[0][1] : 1;

                container.innerHTML = `
                    <div class="p-6 space-y-4">
                        <h3 class="text-gray-800 font-bold mb-4">分類統計</h3>
                        ${sortedSummary.map(([name, amount], index) => `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-xs font-bold text-gray-500">${index + 1}</span>
                                    <span class="text-gray-700 font-medium">${name}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="h-2 w-24 bg-gray-100 rounded-full overflow-hidden hidden sm:block">
                                        <div class="h-full bg-blue-500 rounded-full" style="width: ${(amount / maxVal) * 100}%"></div>
                                    </div>
                                    <span class="font-bold text-gray-800 w-20 text-right">$ ${amount.toLocaleString()}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // --- 6. 事件處理函式 ---

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const btn = document.getElementById('auth-submit-btn');
            const errorDiv = document.getElementById('auth-error');

            btn.disabled = true;
            btn.textContent = '處理中...';
            errorDiv.classList.add('hidden');

            try {
                if (state.authMode === 'register') {
                    if (data.password !== data.confirmPassword) throw new Error("兩次輸入的密碼不一致");
                    if (!data.name.trim()) throw new Error("請輸入姓名");

                    const cred = await createUserWithEmailAndPassword(auth, data.email, data.password);
                    await updateProfile(cred.user, { displayName: data.name });
                    
                    // 寫入使用者資料到 Firestore
                    await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid), {
                        uid: cred.user.uid,
                        name: data.name,
                        email: data.email,
                        createdAt: serverTimestamp()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, data.email, data.password);
                }
            } catch (err) {
                console.error(err);
                let msg = "發生錯誤";
                if (err.message.includes("password")) msg = "密碼錯誤";
                if (err.message.includes("email")) msg = "Email 格式錯誤或已被使用";
                if (err.message.includes("credential")) msg = "帳號密碼錯誤";
                if (err.message.includes("兩次")) msg = err.message;
                errorDiv.textContent = msg;
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = state.authMode === 'register' ? '立即註冊' : '登入系統';
            }
        }

        async function handleAddTransaction(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            const formData = new FormData(form);
            const amountStr = formData.get('amount');
            
            if (!formData.get('item') || !amountStr) {
                alert('請輸入項目與金額');
                return;
            }

            const data = {
                date: formData.get('date'),
                time: formData.get('time'),
                item: formData.get('item'),
                amount: Number(amountStr)
            };

            submitBtn.disabled = true;
            submitBtn.innerHTML = '儲存中...';

            try {
                const colRef = collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions');
                
                await addDoc(colRef, {
                    ...data,
                    createdAt: serverTimestamp()
                });
                
                form.querySelector('input[name="item"]').value = '';
                form.querySelector('input[name="amount"]').value = '';
                
            } catch (err) {
                console.error("Add Transaction Error:", err);
                alert(`新增失敗: ${err.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> 新增支出`;
                if (window.lucide) window.lucide.createIcons();
            }
        }

        // --- 7. 全域函式 ---
        window.setFilterType = (type) => {
            state.filterType = type;
            renderDashboard();
        };

        window.setViewMode = (mode) => {
            state.viewMode = mode;
            renderDashboard();
        };

        window.deleteTransaction = async (id) => {
            if (!confirm('確定要刪除這筆資料嗎？')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'transactions', id));
            } catch (e) {
                console.error(e);
            }
        };

        // --- 8. 啟動 ---
        initAuth();

    </script>
</body>
</html>