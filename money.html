import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, 
  signOut, 
  onAuthStateChanged,
  updateProfile,
  signInWithCustomToken,
  signInAnonymously
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc,
  setDoc, // 新增：用於指定 ID 寫入文件 (註冊時用)
  onSnapshot, 
  doc, 
  deleteDoc, 
  query, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Wallet, 
  User, 
  Lock, 
  Mail, 
  LogOut, 
  PlusCircle, 
  Calendar, 
  Clock, 
  DollarSign, 
  Tag,
  Trash2,
  PieChart,
  List,
  Filter,
  CheckCircle,
  AlertCircle
} from 'lucide-react';

// --- Firebase 初始化 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- 元件：財務管理系統主程式 ---
export default function FinanceApp() {
  const [user, setUser] = useState(null);
  const [authView, setAuthView] = useState('login'); // 'login' or 'register'
  const [loading, setLoading] = useState(true);

  // 初始化 Auth
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        setLoading(false);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 text-gray-500">
        <div className="animate-spin mr-2"><div className="h-6 w-6 border-4 border-blue-500 border-t-transparent rounded-full"></div></div>
        載入系統中...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
      {user ? (
        <Dashboard user={user} />
      ) : (
        <AuthPage view={authView} setView={setAuthView} />
      )}
    </div>
  );
}

// --- 元件：認證頁面 (登入/註冊) ---
function AuthPage({ view, setView }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [name, setName] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const isRegister = view === 'register';

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      if (isRegister) {
        // --- 註冊流程 ---
        if (password !== confirmPassword) {
          throw new Error("兩次輸入的密碼不一致");
        }
        if (!name.trim()) {
          throw new Error("請輸入您的姓名");
        }
        
        // 1. 在 Firebase Auth 建立帳號
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const newUser = userCredential.user;

        // 2. 更新 Auth 個人資料 (顯示名稱)
        await updateProfile(newUser, {
          displayName: name
        });

        // 3. 將註冊資訊寫入 Firestore (users 集合)
        // 路徑: artifacts/{appId}/users/{uid}
        await setDoc(doc(db, 'artifacts', appId, 'users', newUser.uid), {
          uid: newUser.uid,
          name: name,
          email: email,
          createdAt: serverTimestamp()
        });

      } else {
        // --- 登入流程 ---
        await signInWithEmailAndPassword(auth, email, password);
      }
    } catch (err) {
      console.error(err);
      let msg = "發生錯誤，請稍後再試";
      if (err.message.includes("password")) msg = "密碼錯誤或不一致";
      if (err.message.includes("email")) msg = "Email 格式錯誤或已被使用";
      if (err.message.includes("credential")) msg = "帳號或密碼錯誤";
      if (err.message.includes("兩次輸入")) msg = err.message;
      if (err.message.includes("姓名")) msg = err.message;
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
        
        <div className="flex flex-col items-center mb-8">
          <div className="bg-blue-100 p-4 rounded-full mb-4">
            <Wallet className="w-8 h-8 text-blue-600" />
          </div>
          <h2 className="text-2xl font-bold text-gray-800">
            {isRegister ? '註冊新帳號' : '登入財務系統'}
          </h2>
          <p className="text-gray-500 text-sm mt-1">
            {isRegister ? '建立您的個人財務管理檔案' : '歡迎回來，請輸入您的帳號資訊'}
          </p>
        </div>

        {error && (
          <div className="mb-6 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex items-center">
            <AlertCircle className="w-4 h-4 mr-2" />
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-5">
          {/* 姓名欄位 (僅註冊顯示) */}
          {isRegister && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">姓名</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  required
                  className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  placeholder="王小明"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                />
              </div>
            </div>
          )}

          {/* Email */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">帳號 (Email)</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Mail className="h-5 w-5 text-gray-400" />
              </div>
              <input
                type="email"
                required
                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                placeholder="name@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
          </div>

          {/* 密碼 */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Lock className="h-5 w-5 text-gray-400" />
              </div>
              <input
                type="password"
                required
                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                placeholder="••••••••"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          {/* 確認密碼 (僅註冊顯示) */}
          {isRegister && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">確認密碼</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  type="password"
                  required
                  className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  placeholder="再次輸入密碼"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                />
              </div>
            </div>
          )}

          <button
            type="submit"
            disabled={loading}
            className={`w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white ${
              loading ? 'bg-gray-400' : 'bg-emerald-600 hover:bg-emerald-700'
            } focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors`}
          >
            {loading ? '處理中...' : (isRegister ? '立即註冊' : '登入系統')}
          </button>
        </form>

        <div className="mt-6 flex items-center justify-center space-x-2 text-sm">
          <span className="text-gray-500">
            {isRegister ? '已經有帳號了嗎？' : '還沒有帳號嗎？'}
          </span>
          <button
            onClick={() => {
              setView(isRegister ? 'login' : 'register');
              setError('');
              setName('');
              setEmail('');
              setPassword('');
              setConfirmPassword('');
            }}
            className="font-medium text-blue-600 hover:text-blue-500"
          >
            {isRegister ? '直接登入' : '註冊新帳號'}
          </button>
        </div>
      </div>
    </div>
  );
}

// --- 元件：主控台 (Dashboard) ---
function Dashboard({ user }) {
  const [transactions, setTransactions] = useState([]);
  const [loadingData, setLoadingData] = useState(true);
  
  // 篩選與顯示狀態
  const [filterType, setFilterType] = useState('month'); // day, month, year, custom
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [viewMode, setViewMode] = useState('list'); // list, summary

  // 取得資料
  useEffect(() => {
    if (!user) return;

    // 從 Firestore 取得記帳資料
    // 路徑: artifacts/{appId}/users/{uid}/transactions
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      // 前端排序：日期(降序) > 時間(降序)
      data.sort((a, b) => {
        if (b.date !== a.date) {
          return b.date.localeCompare(a.date);
        }
        return b.time.localeCompare(a.time);
      });

      setTransactions(data);
      setLoadingData(false);
    }, (error) => {
      console.error("Error fetching transactions:", error);
      setLoadingData(false);
    });

    return () => unsubscribe();
  }, [user]);

  // 新增交易：這段程式碼負責將記帳資料寫入 Firestore
  const handleAddTransaction = async (formData) => {
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), {
        ...formData,
        amount: Number(formData.amount),
        createdAt: serverTimestamp() // 加入伺服器時間戳記
      });
      return true;
    } catch (e) {
      console.error("Error adding doc: ", e);
      alert("新增失敗");
      return false;
    }
  };

  // 刪除交易
  const handleDelete = async (id) => {
    if(!window.confirm("確定要刪除這筆資料嗎？")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id));
    } catch (e) {
      console.error("Error deleting: ", e);
    }
  };

  // 過濾邏輯
  const filteredTransactions = useMemo(() => {
    const now = new Date();
    
    return transactions.filter(t => {
      // 處理日期比對 (避免時區問題，手動解析 YYYY-MM-DD)
      const [y, m, d] = t.date.split('-').map(Number);
      const localTDate = new Date(y, m - 1, d);

      if (filterType === 'day') {
        return localTDate.toDateString() === now.toDateString();
      } else if (filterType === 'month') {
        return localTDate.getMonth() === now.getMonth() && localTDate.getFullYear() === now.getFullYear();
      } else if (filterType === 'year') {
        return localTDate.getFullYear() === now.getFullYear();
      } else if (filterType === 'custom') {
        if (!customStartDate || !customEndDate) return true;
        const start = new Date(customStartDate);
        const end = new Date(customEndDate);
        start.setHours(0,0,0,0);
        end.setHours(23,59,59,999);
        return localTDate >= start && localTDate <= end;
      }
      return true;
    });
  }, [transactions, filterType, customStartDate, customEndDate]);

  // 計算總金額
  const totalAmount = filteredTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);

  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      {/* 頂部導覽 */}
      <header className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div className="flex items-center space-x-4 mb-4 md:mb-0">
          <div className="bg-indigo-100 p-3 rounded-full">
            <User className="w-6 h-6 text-indigo-600" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-gray-800">
              嗨，{user.displayName || '使用者'}
            </h1>
            <p className="text-sm text-gray-500">歡迎使用您的個人財務系統</p>
          </div>
        </div>
        <button 
          onClick={() => signOut(auth)}
          className="flex items-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors"
        >
          <LogOut className="w-4 h-4 mr-2" />
          登出
        </button>
      </header>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* 左側：新增表單 */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-8">
            <h2 className="text-lg font-bold text-gray-800 mb-6 flex items-center">
              <PlusCircle className="w-5 h-5 mr-2 text-emerald-500" />
              記一筆帳
            </h2>
            <TransactionForm onAdd={handleAddTransaction} />
          </div>
        </div>

        {/* 右側：列表與查詢 */}
        <div className="lg:col-span-2 space-y-6">
          
          {/* 過濾器與總覽卡片 */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
              <div className="flex flex-wrap gap-2">
                {[
                  { id: 'day', label: '今日' },
                  { id: 'month', label: '本月' },
                  { id: 'year', label: '今年' },
                  { id: 'custom', label: '自訂區間' },
                ].map(type => (
                  <button
                    key={type.id}
                    onClick={() => setFilterType(type.id)}
                    className={`px-3 py-1.5 text-sm rounded-full transition-colors ${
                      filterType === type.id 
                        ? 'bg-blue-600 text-white shadow-md' 
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {type.label}
                  </button>
                ))}
              </div>
              
              <div className="flex items-center space-x-2 bg-gray-50 p-1 rounded-lg border border-gray-200">
                <button
                  onClick={() => setViewMode('list')}
                  className={`p-2 rounded-md ${viewMode === 'list' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-400'}`}
                  title="詳細列表"
                >
                  <List className="w-5 h-5" />
                </button>
                <button
                  onClick={() => setViewMode('summary')}
                  className={`p-2 rounded-md ${viewMode === 'summary' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-400'}`}
                  title="金額統計"
                >
                  <PieChart className="w-5 h-5" />
                </button>
              </div>
            </div>

            {/* 自訂日期選擇器 */}
            {filterType === 'custom' && (
              <div className="flex items-center gap-2 mb-6 bg-blue-50 p-3 rounded-lg animate-fade-in">
                <input 
                  type="date" 
                  value={customStartDate}
                  onChange={(e) => setCustomStartDate(e.target.value)}
                  className="border rounded px-2 py-1 text-sm"
                />
                <span className="text-gray-400">至</span>
                <input 
                  type="date" 
                  value={customEndDate}
                  onChange={(e) => setCustomEndDate(e.target.value)}
                  className="border rounded px-2 py-1 text-sm"
                />
              </div>
            )}

            {/* 總金額顯示 */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg flex justify-between items-center">
              <div>
                <p className="text-blue-100 text-sm mb-1">
                  {filterType === 'day' ? '今日支出' : 
                   filterType === 'month' ? '本月支出' : 
                   filterType === 'year' ? '年度支出' : '區間總計'}
                </p>
                <h3 className="text-3xl font-bold">
                  $ {totalAmount.toLocaleString()}
                </h3>
              </div>
              <div className="bg-white/20 p-3 rounded-full backdrop-blur-sm">
                <DollarSign className="w-8 h-8 text-white" />
              </div>
            </div>
          </div>

          {/* 資料列表/統計視圖 */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
             {loadingData ? (
               <div className="p-8 text-center text-gray-500">載入資料中...</div>
             ) : filteredTransactions.length === 0 ? (
               <div className="p-12 text-center flex flex-col items-center text-gray-400">
                 <Filter className="w-12 h-12 mb-3 opacity-20" />
                 <p>此區間沒有支出紀錄</p>
               </div>
             ) : (
               viewMode === 'list' ? (
                 <div className="divide-y divide-gray-100">
                   {filteredTransactions.map(t => (
                     <div key={t.id} className="p-4 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                       <div className="flex items-start gap-4">
                         <div className="bg-emerald-100 text-emerald-600 p-2.5 rounded-lg">
                           <Tag className="w-5 h-5" />
                         </div>
                         <div>
                           <h4 className="font-bold text-gray-800">{t.item}</h4>
                           <div className="flex items-center text-xs text-gray-500 mt-1 space-x-3">
                             <span className="flex items-center"><Calendar className="w-3 h-3 mr-1" /> {t.date}</span>
                             <span className="flex items-center"><Clock className="w-3 h-3 mr-1" /> {t.time}</span>
                           </div>
                         </div>
                       </div>
                       <div className="flex items-center gap-4">
                         <span className="font-bold text-gray-800 text-lg">
                           - {t.amount.toLocaleString()}
                         </span>
                         <button 
                           onClick={() => handleDelete(t.id)}
                           className="text-gray-300 hover:text-red-500 transition-colors p-2"
                         >
                           <Trash2 className="w-4 h-4" />
                         </button>
                       </div>
                     </div>
                   ))}
                 </div>
               ) : (
                 <SummaryView transactions={filteredTransactions} />
               )
             )}
          </div>

        </div>
      </div>
    </div>
  );
}

// --- 元件：新增交易表單 ---
function TransactionForm({ onAdd }) {
  const getToday = () => new Date().toISOString().split('T')[0];
  const getNow = () => {
    const d = new Date();
    return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
  };

  const [date, setDate] = useState(getToday());
  const [time, setTime] = useState(getNow());
  const [item, setItem] = useState('');
  const [amount, setAmount] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!item || !amount) return;
    setIsSubmitting(true);

    const success = await onAdd({ date, time, item, amount });
    
    if (success) {
      setItem('');
      setAmount('');
      // Date and Time keep current/user selected
    }
    setIsSubmitting(false);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">日期</label>
        <div className="relative">
          <Calendar className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
          <input
            type="date"
            required
            value={date}
            onChange={e => setDate(e.target.value)}
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      <div>
        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">時間</label>
        <div className="relative">
          <Clock className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
          <input
            type="time"
            required
            value={time}
            onChange={e => setTime(e.target.value)}
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      <div>
        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">項目名稱</label>
        <div className="relative">
          <Tag className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
          <input
            type="text"
            required
            placeholder="例如：午餐、車費"
            value={item}
            onChange={e => setItem(e.target.value)}
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      <div>
        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">金額</label>
        <div className="relative">
          <DollarSign className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
          <input
            type="number"
            required
            min="0"
            placeholder="0"
            value={amount}
            onChange={e => setAmount(e.target.value)}
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      <button
        type="submit"
        disabled={isSubmitting}
        className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-sm transition-all hover:shadow-md flex items-center justify-center"
      >
        {isSubmitting ? '儲存中...' : (
          <>
            <PlusCircle className="w-4 h-4 mr-2" />
            新增支出
          </>
        )}
      </button>
    </form>
  );
}

// --- 元件：統計視圖 (只顯示金額總和/細項分類) ---
function SummaryView({ transactions }) {
  // 依項目名稱合併計算
  const summary = useMemo(() => {
    const acc = {};
    transactions.forEach(t => {
      if (!acc[t.item]) acc[t.item] = 0;
      acc[t.item] += Number(t.amount);
    });
    return Object.entries(acc)
      .sort((a, b) => b[1] - a[1]); // 金額從大到小排序
  }, [transactions]);

  return (
    <div className="p-6">
      <h3 className="text-gray-800 font-bold mb-4">分類統計</h3>
      <div className="space-y-4">
        {summary.map(([name, amount], index) => (
          <div key={name} className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-xs font-bold text-gray-500">
                {index + 1}
              </span>
              <span className="text-gray-700 font-medium">{name}</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="h-2 w-24 bg-gray-100 rounded-full overflow-hidden hidden sm:block">
                <div 
                  className="h-full bg-blue-500 rounded-full" 
                  style={{ width: `${Math.min((amount / summary[0][1]) * 100, 100)}%` }}
                ></div>
              </div>
              <span className="font-bold text-gray-800 w-20 text-right">
                $ {amount.toLocaleString()}
              </span>
            </div>
          </div>
        ))}
        {summary.length === 0 && <p>無資料</p>}
      </div>
    </div>
  );
}