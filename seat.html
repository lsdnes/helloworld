<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>化一乙座位表排位系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-user-select: none;
            user-select: none;
        }

        .seat {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .seat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .seat.dragging {
            opacity: 0.5;
            border: 2px dashed #4b5563;
        }

        .seat.selected {
            border: 3px solid #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.05);
            z-index: 10;
        }

        .student-list::-webkit-scrollbar {
            width: 6px;
        }
        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .student-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center shrink-0 z-50">
        <div>
            <h1 class="text-xl md:text-2xl font-bold tracking-wider">化一乙 座位表排位系統</h1>
            <p class="text-slate-400 text-xs md:text-sm mt-1">拖曳座位或點擊兩下可交換位置</p>
        </div>
        <div class="flex gap-2">
            <button onclick="resetLayout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded shadow transition text-sm font-bold flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                <span class="hidden md:inline">重置</span>
            </button>
            <button onclick="downloadImage()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded shadow transition text-sm font-bold flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span class="hidden md:inline">下載圖片</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Sidebar: Student List -->
        <aside class="w-48 md:w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 z-20 shadow-lg hidden md:flex">
            <div class="p-4 bg-slate-100 border-b border-gray-200">
                <h2 class="font-bold text-gray-700">學生名單對照</h2>
                <div class="text-xs text-gray-500 mt-1">滑鼠移過可高亮座位</div>
            </div>
            <div id="studentList" class="flex-1 overflow-y-auto student-list p-2 space-y-1">
                <!-- Student items injected here -->
            </div>
        </aside>

        <!-- Right Area: Capture Zone (This part gets exported) -->
        <main class="flex-1 overflow-y-auto bg-slate-200 p-4 md:p-8 flex flex-col items-center relative">
            
            <div id="captureArea" class="bg-slate-200 p-8 w-full max-w-5xl flex flex-col items-center rounded-xl">
                
                <h2 class="text-3xl font-bold text-slate-800 mb-6 border-b-4 border-slate-800 pb-2 px-8">化一乙 座位表</h2>

                <!-- Podium -->
                <div class="mb-6 w-48 h-12 bg-amber-800 rounded flex items-center justify-center text-amber-100 shadow-lg border-b-4 border-amber-950 shrink-0">
                    <span class="text-lg font-bold tracking-widest">講 台</span>
                </div>

                <!-- Column Labels -->
                <div class="w-full grid grid-cols-6 gap-2 mb-2 text-center text-slate-500 font-bold text-xl font-mono">
                    <div>6</div><div>5</div><div>4</div><div>3</div><div>2</div><div>1</div>
                </div>

                <!-- The Grid -->
                <div id="seatingGrid" class="grid grid-cols-6 gap-3 w-full p-4 bg-slate-300 rounded-xl shadow-inner border border-slate-400 mb-8">
                    <!-- Seats injected here -->
                </div>

                <!-- Officers List -->
                <div class="w-full bg-white rounded-lg shadow border border-gray-300 p-4 mt-4">
                    <h3 class="text-center font-bold text-slate-700 text-lg mb-4 border-b pb-2">班級幹部名單</h3>
                    <div id="officerGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 text-sm">
                        <!-- Officers injected here -->
                    </div>
                </div>

                <div class="text-xs text-slate-400 mt-4 text-center w-full">
                    Generated by Seating Chart App
                </div>
            </div>

        </main>
    </div>

    <!-- Data & Logic -->
    <script>
        const students = {
            1: "吳夢佳", 2: "林豈潼", 3: "紀宇玹", 4: "紀汶彤", 5: "郭芷妍",
            6: "陳亭汝", 7: "喻予函", 8: "賴郁璇", 9: "王睿宸", 10: "江晨瑋",
            11: "卓釗緒", 12: "林皇成", 13: "洪士桓", 14: "莊承翰", 15: "陳冠叡",
            16: "陳彥霖", 17: "陳科宏", 18: "陳智宇", 19: "彭正鉱", 20: "曾文彥",
            21: "曾彥嵐", 22: "曾浚恩", 23: "詹宸睿", 24: "廖紘逵", 25: "潘尚恩",
            26: "蔡文洋", 27: "蔡仲恩", 28: "蔡承晏", 29: "蔡東錄", 30: "蔡倍恩",
            31: "鄭文弘", 32: "鄭淇成", 33: "鄭凱鴻", 34: "蕭承閎", 35: "魏胤程"
        };

        const officers = [
            { role: "班長", id: 1 }, { role: "副班長", id: 4 },
            { role: "學藝", id: 5 }, { role: "事務", id: 24 },
            { role: "風紀", id: 26 }, { role: "衛生", id: 29 },
            { role: "會心", id: 18 }, { role: "康樂", id: 33 },
            { role: "圖書", id: 22 }, { role: "實習", id: 8 },
            { role: "環評", id: 17 }, { role: "節能", id: 23 },
            { role: "資訊", id: 19 }, { role: "環保", id: 25 }
        ];

        // Initial layout based on the blackboard image
        // 6 columns (left to right visual: 6,5,4,3,2,1)
        const initialLayout = [
            null, 5, 1, 13, 26, 29,
            4, 8, 6, 33, 27, 9,
            22, 19, 28, 31, 14, 2,
            34, 10, 21, 32, 17, 35,
            11, 18, 12, 30, 23, 20,
            7, 24, 15, 25, 16, 3
        ];

        let currentLayout = [...initialLayout];
        let selectedIndex = null;

        const gridEl = document.getElementById('seatingGrid');
        const studentListEl = document.getElementById('studentList');
        const officerGridEl = document.getElementById('officerGrid');

        function init() {
            renderStudentList();
            renderOfficers();
            renderGrid();
        }

        function renderStudentList() {
            studentListEl.innerHTML = '';
            for (let i = 1; i <= 35; i++) {
                const div = document.createElement('div');
                div.className = "flex items-center p-2 rounded cursor-pointer hover:bg-blue-50 transition border border-transparent hover:border-blue-100 group";
                div.innerHTML = `
                    <span class="w-6 h-6 flex items-center justify-center bg-slate-200 text-slate-600 rounded-full text-xs font-bold mr-2 group-hover:bg-blue-500 group-hover:text-white transition">${i}</span>
                    <span class="text-sm text-gray-700 font-medium">${students[i]}</span>
                `;
                div.addEventListener('mouseenter', () => highlightSeat(i, true));
                div.addEventListener('mouseleave', () => highlightSeat(i, false));
                studentListEl.appendChild(div);
            }
        }

        function renderOfficers() {
            officerGridEl.innerHTML = '';
            officers.forEach(off => {
                const div = document.createElement('div');
                div.className = "flex flex-col bg-slate-50 p-2 rounded border border-slate-200 items-center";
                div.innerHTML = `
                    <span class="text-xs font-bold text-slate-400 mb-1">${off.role}</span>
                    <div class="flex items-baseline gap-1">
                        <span class="font-mono font-bold text-blue-600">${off.id}</span>
                        <span class="text-gray-800 font-medium">${students[off.id]}</span>
                    </div>
                `;
                officerGridEl.appendChild(div);
            });
        }

        function highlightSeat(studentId, isActive) {
            const seats = document.querySelectorAll('.seat-item');
            seats.forEach(seat => {
                const id = parseInt(seat.getAttribute('data-id'));
                if (id === studentId) {
                    if (isActive) {
                        seat.classList.add('ring-4', 'ring-yellow-300', 'bg-yellow-50', 'scale-105', 'z-10');
                    } else {
                        seat.classList.remove('ring-4', 'ring-yellow-300', 'bg-yellow-50', 'scale-105', 'z-10');
                    }
                }
            });
        }

        function renderGrid() {
            gridEl.innerHTML = '';
            currentLayout.forEach((studentId, index) => {
                const seatWrapper = document.createElement('div');
                seatWrapper.className = "aspect-[4/3] md:aspect-[3/2]";
                
                const seatEl = document.createElement('div');
                seatEl.className = `seat-item w-full h-full rounded-lg shadow-sm border border-slate-200 p-1 flex flex-col items-center justify-center select-none cursor-pointer transition-all duration-200 relative
                    ${studentId === null ? 'bg-slate-300/50 border-dashed border-slate-400' : 'bg-white hover:border-blue-300'}`;
                
                if (studentId !== null) {
                    seatEl.setAttribute('draggable', 'true');
                    seatEl.setAttribute('data-id', studentId);
                    
                    // Check if officer
                    const isOfficer = officers.find(o => o.id === studentId);
                    const officerBadge = isOfficer ? `<span class="absolute top-0 right-0 -mt-1 -mr-1 w-2 h-2 bg-red-500 rounded-full"></span>` : '';

                    seatEl.innerHTML = `
                        ${officerBadge}
                        <div class="text-xl md:text-3xl font-bold text-slate-800 font-mono leading-none mb-1">${studentId}</div>
                        <div class="text-xs md:text-sm font-medium text-slate-600 truncate w-full text-center px-1">${students[studentId]}</div>
                    `;
                } else {
                    seatEl.innerHTML = `<span class="text-slate-400 text-xl font-bold opacity-30">✕</span>`;
                }

                seatEl.setAttribute('data-index', index);

                // Events
                addInteractionEvents(seatEl, index);

                seatWrapper.appendChild(seatEl);
                gridEl.appendChild(seatWrapper);
            });
        }

        function addInteractionEvents(el, index) {
            el.addEventListener('dragstart', (e) => {
                if (currentLayout[index] === null) {
                    e.preventDefault();
                    return;
                }
                e.dataTransfer.setData('text/plain', index);
                el.classList.add('dragging');
            });

            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
            });

            el.addEventListener('dragover', (e) => {
                e.preventDefault(); // Necessary for drop
            });

            el.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                if (fromIndex !== index) {
                    swapSeats(fromIndex, index);
                }
            });

            el.addEventListener('click', () => {
                // Click swap logic
                if (selectedIndex === null) {
                    if (currentLayout[index] !== null) {
                        selectedIndex = index;
                        el.classList.add('selected');
                    }
                } else {
                    if (selectedIndex !== index) {
                        swapSeats(selectedIndex, index);
                    }
                    // Reset selection
                    const prevSelected = document.querySelector('.seat-item.selected');
                    if (prevSelected) prevSelected.classList.remove('selected');
                    selectedIndex = null;
                }
            });
        }

        function swapSeats(idx1, idx2) {
            const temp = currentLayout[idx1];
            currentLayout[idx1] = currentLayout[idx2];
            currentLayout[idx2] = temp;
            renderGrid();
        }

        function resetLayout() {
            if(confirm('確定要還原成黑板上的預設座位嗎？目前的更動將會消失。')) {
                currentLayout = [...initialLayout];
                renderGrid();
            }
        }

        async function downloadImage() {
            const captureArea = document.getElementById('captureArea');
            const btn = document.querySelector('button[onclick="downloadImage()"] span');
            const originalText = btn.innerText;
            
            btn.innerText = "產生中...";
            
            try {
                // Wait for any images or styles to settle
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvas = await html2canvas(captureArea, {
                    scale: 2, // Higher resolution
                    backgroundColor: "#e2e8f0", // Match slate-200
                    logging: false
                });

                const link = document.createElement('a');
                link.download = `化一乙座位表_${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } catch (err) {
                console.error(err);
                alert("圖片產生失敗，請稍後再試");
            } finally {
                btn.innerText = originalText;
            }
        }

        init();
    </script>
</body>
</html>