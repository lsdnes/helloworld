<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•æ­¡æ¨‚æ‘¸å½©æ´¾å° ğŸ…</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: radial-gradient(circle at center, #1a472a 0%, #0d2b18 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Snow effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            cursor: default;
            animation-name: snowflakes-fall, snowflakes-shake;
            animation-duration: 10s, 3s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
            animation-play-state: running, running;
        }
        
        @keyframes snowflakes-fall {
            0% { top: -10%; }
            100% { top: 100%; }
        }
        
        @keyframes snowflakes-shake {
            0% { transform: translateX(0px); }
            50% { transform: translateX(80px); }
            100% { transform: translateX(0px); }
        }

        .snowflake:nth-of-type(1) { left: 1%; animation-delay: 0s, 0s; }
        .snowflake:nth-of-type(2) { left: 10%; animation-delay: 1s, 1s; }
        .snowflake:nth-of-type(3) { left: 20%; animation-delay: 6s, 0.5s; }
        .snowflake:nth-of-type(4) { left: 30%; animation-delay: 4s, 2s; }
        .snowflake:nth-of-type(5) { left: 40%; animation-delay: 2s, 2s; }
        .snowflake:nth-of-type(6) { left: 50%; animation-delay: 8s, 3s; }
        .snowflake:nth-of-type(7) { left: 60%; animation-delay: 6s, 2s; }
        .snowflake:nth-of-type(8) { left: 70%; animation-delay: 2.5s, 1s; }
        .snowflake:nth-of-type(9) { left: 80%; animation-delay: 1s, 0s; }
        .snowflake:nth-of-type(10) { left: 90%; animation-delay: 3s, 1.5s; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-christmas {
            background: rgba(255, 255, 255, 0.9);
            color: #1a472a;
            border: 2px solid #c41e3a;
        }

        .btn-christmas {
            background: linear-gradient(to bottom, #d42426, #b3000c);
            border: 2px solid #ffd700;
            box-shadow: 0 4px 0 #8b0000;
            transition: all 0.1s;
        }
        .btn-christmas:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #8b0000;
        }

        .gold-text {
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .winner-animation {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        .rolling {
            animation: blurText 0.1s infinite;
        }

        @keyframes blurText {
            0% { filter: blur(0px); transform: translateY(0); }
            50% { filter: blur(2px); transform: translateY(-2px); }
            100% { filter: blur(0px); transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen relative pb-10">

    <!-- Snowflakes -->
    <div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div>
    <div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div>
    <div class="snowflake">â…</div><div class="snowflake">â†</div>

    <!-- Header -->
    <header class="w-full p-4 text-center z-10 relative mt-4">
        <h1 class="text-4xl md:text-6xl font-bold gold-text mb-2 drop-shadow-lg">
            <i class="fa-solid fa-tree text-green-400"></i> è–èª•æ­¡æ¨‚æ‘¸å½© <i class="fa-solid fa-gifts text-red-500"></i>
        </h1>
        <p class="text-lg text-gray-200">ç¥å¤§å®¶è–èª•å¿«æ¨‚ Merry Christmas</p>
    </header>

    <!-- Main Content Area -->
    <main class="w-full max-w-md md:max-w-2xl p-4 z-10 relative flex-grow">
        
        <!-- Registration View (Default) -->
        <div id="registrationView" class="glass-panel rounded-2xl p-6 md:p-8 w-full max-w-md mx-auto transition-all duration-300">
            <div class="text-center mb-6">
                <i class="fa-solid fa-ticket text-5xl text-yellow-400 mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ç™»è¨˜åƒåŠ æŠ½ç</h2>
                <p class="text-sm opacity-80">å¡«å¯«è³‡æ–™ï¼Œå°‡æœ‰æ©Ÿæœƒç²å¾—å¤§çï¼</p>
                <!-- Debug Status Indicator -->
                <p id="connectionStatus" class="text-xs mt-2 text-yellow-300 animate-pulse">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> æ­£åœ¨é€£ç·šåˆ°ä¼ºæœå™¨...
                </p>
            </div>

            <form id="raffleForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 ml-1">æ‚¨çš„å§“å / Name</label>
                    <input type="text" id="guestName" required placeholder="è«‹è¼¸å…¥å§“å" 
                        class="input-christmas w-full p-3 rounded-lg outline-none focus:ring-4 focus:ring-yellow-400">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 ml-1">æ‰‹æ©Ÿè™Ÿç¢¼ / Phone</label>
                    <input type="tel" id="guestPhone" required placeholder="0912-345-678" 
                        class="input-christmas w-full p-3 rounded-lg outline-none focus:ring-4 focus:ring-yellow-400">
                </div>
                <button type="submit" class="btn-christmas w-full py-4 rounded-lg text-xl font-bold mt-4 text-white">
                    <i class="fa-solid fa-paper-plane mr-2"></i> ç¢ºèªé€å‡º
                </button>
            </form>

            <div id="successMessage" class="hidden text-center mt-6 p-4 bg-green-800 bg-opacity-80 rounded-lg border-2 border-green-400">
                <i class="fa-solid fa-check-circle text-4xl text-green-300 mb-2"></i>
                <h3 class="text-xl font-bold">ç™»è¨˜æˆåŠŸï¼</h3>
                <p>è«‹ç•™æ„æ™šæœƒæŠ½çç’°ç¯€</p>
                <button id="registerAgainBtn" class="mt-4 text-sm underline text-gray-300 hover:text-white">é‡æ–°ç™»è¨˜(æ¸¬è©¦ç”¨)</button>
            </div>
        </div>

        <!-- Admin Dashboard View (Hidden by default) -->
        <div id="adminView" class="hidden w-full transition-all duration-300">
            <div class="glass-panel rounded-2xl p-6 md:p-8 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-500 pb-4">
                    <div>
                        <h2 class="text-3xl font-bold gold-text">å¾Œå°ç®¡ç†ä¸­å¿ƒ</h2>
                        <p class="text-sm">ç›®å‰çš„åƒåŠ äººæ•¸: <span id="participantCount" class="text-2xl font-bold text-yellow-400">0</span> äºº</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex gap-2">
                        <button onclick="resetData()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm border border-gray-500">
                            <i class="fa-solid fa-trash-can"></i> é‡ç½®æ´»å‹•
                        </button>
                        <button onclick="exitAdmin()" class="bg-red-800 hover:bg-red-700 px-4 py-2 rounded text-sm border border-red-500">
                            <i class="fa-solid fa-sign-out-alt"></i> é›¢é–‹å¾Œå°
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- QR Code Section -->
                    <div class="bg-white bg-opacity-90 p-4 rounded-xl text-center text-gray-800 flex flex-col items-center justify-center">
                        <h3 class="font-bold text-lg mb-2 text-[#1a472a]">æƒæåŠ å…¥æŠ½ç</h3>
                        <div id="qrcode" class="border-4 border-[#c41e3a] p-2 bg-white rounded-lg"></div>
                        <p class="text-xs mt-2 text-gray-600">è«‹ä¾†è³“æƒææ­¤ QR Code</p>
                    </div>

                    <!-- Draw Control Section -->
                    <div class="flex flex-col justify-center items-center text-center">
                        <div id="drawDisplay" class="w-full h-32 bg-black bg-opacity-50 rounded-xl border-4 border-yellow-400 flex items-center justify-center mb-4 overflow-hidden relative">
                            <div id="scrollingName" class="text-4xl font-bold text-white">æº–å‚™æŠ½ç</div>
                            <div id="fireworks" class="absolute inset-0 pointer-events-none"></div>
                        </div>
                        
                        <button id="drawBtn" class="btn-christmas w-full py-4 rounded-lg text-2xl font-bold text-white relative overflow-hidden group">
                            <span class="relative z-10"><i class="fa-solid fa-star"></i> é–‹å§‹æŠ½ç</span>
                            <div class="absolute top-0 left-0 w-full h-full bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participant List -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4 border-b border-gray-500 pb-2">
                    <i class="fa-solid fa-users"></i> åƒåŠ è€…åå–®
                </h3>
                <div class="overflow-y-auto max-h-60 custom-scrollbar">
                    <table class="w-full text-left">
                        <thead class="bg-black bg-opacity-30 text-yellow-400">
                            <tr>
                                <th class="p-3">å§“å</th>
                                <th class="p-3">é›»è©± (æœ«ä¸‰ç¢¼)</th>
                                <th class="p-3">æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody id="participantTableBody" class="divide-y divide-gray-600">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer / Admin Toggle -->
    <footer class="w-full text-center p-4 z-10 text-sm text-gray-400">
        <p class="mb-2">Happy Holidays & Good Luck!</p>
        <button id="adminToggleBtn" class="opacity-30 hover:opacity-100 transition-opacity text-xs border border-gray-600 px-2 py-1 rounded">
            ğŸ… ä¸»æŒäººå¾Œå°
        </button>
    </footer>

    <!-- Admin Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center">
        <div class="bg-white text-gray-900 p-6 rounded-xl max-w-sm w-full mx-4 shadow-2xl border-4 border-[#1a472a]">
            <h3 class="text-xl font-bold mb-4 text-[#1a472a] text-center">è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼</h3>
            <p class="text-xs text-gray-500 text-center mb-4">(é è¨­å¯†ç¢¼: 1225)</p>
            <input type="password" id="adminPassword" class="w-full border-2 border-gray-300 p-2 rounded mb-4 text-center text-lg" placeholder="Password">
            <div class="flex gap-2">
                <button onclick="closePasswordModal()" class="flex-1 bg-gray-300 py-2 rounded font-bold hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="checkPassword()" class="flex-1 bg-[#c41e3a] text-white py-2 rounded font-bold hover:bg-[#a01830]">é€²å…¥</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, getDocs, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config & Init ---
        // âš ï¸ éƒ¨ç½²åˆ° GitHub Pages å‰çš„å¿…åšè¨­å®š / REQUIRED SETUP FOR GITHUB PAGES
        // ------------------------------------------------------------------
        // è«‹åˆ° Firebase Console (https://console.firebase.google.com/)
        // å»ºç«‹ä¸€å€‹å°ˆæ¡ˆï¼Œä¸¦è¤‡è£½ "Web App" çš„è¨­å®šè²¼åœ¨ä¸‹æ–¹ï¼š
        
        const manualConfig = {
            // è«‹å°‡ä¸‹æ–¹çš„å­—ä¸²æ›¿æ›ç‚ºæ‚¨çš„ Firebase å¯¦éš›è¨­å®š
            // Please replace the strings below with your actual Firebase config
            apiKey: "AIzaSyB4mNbRMkVAY-R5JSrF2O7fPN4dDry8alI",
			authDomain: "xmas-1654f.firebaseapp.com",
			projectId: "xmas-1654f",
			storageBucket: "xmas-1654f.firebasestorage.app",
			messagingSenderId: "171667807726",
			appId: "1:171667807726:web:485e64aa2ec736ef4f02ff",
			measurementId: "G-ZBN2J3BKLD"
        };

        // è‡ªå‹•åˆ¤æ–·ç’°å¢ƒï¼š
        // 1. å¦‚æœæ˜¯åœ¨ AI å°è©±è¦–çª—ï¼Œä½¿ç”¨è‡ªå‹•æ³¨å…¥çš„è®Šæ•¸ (__firebase_config)
        // 2. å¦‚æœæ˜¯åœ¨ GitHub / æœ¬åœ°ç«¯ï¼Œä½¿ç”¨ä¸Šæ–¹çš„ manualConfig
        let finalConfig;
        let finalAppId;

        try {
            if (typeof __firebase_config !== 'undefined') {
                finalConfig = JSON.parse(__firebase_config);
                finalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
            } else {
                finalConfig = manualConfig;
                finalAppId = 'christmas-raffle-v1'; // è‡ªè¨‚ App ID
            }
        } catch (e) {
            finalConfig = manualConfig;
            finalAppId = 'christmas-raffle-v1';
        }

        // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š (è‹¥åœ¨ GitHub ä¸Šä¸”æœªè¨­å®šï¼Œè·³å‡ºè­¦å‘Š)
        if (typeof __firebase_config === 'undefined' && finalConfig.apiKey === "æ›¿æ›æˆæ‚¨çš„_apiKey") {
            alert("âš ï¸ å°šæœªè¨­å®š Firebaseï¼\n\nç¨‹å¼ç„¡æ³•é€£ç·šè³‡æ–™åº«ï¼ŒæŒ‰éˆ•å°‡ç„¡åæ‡‰ã€‚\n\nè«‹ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹æ­¤ HTML æª”æ¡ˆï¼Œ\næœå°‹ 'const manualConfig' ä¸¦å¡«å…¥æ‚¨çš„è¨­å®šã€‚");
            console.error("Firebase config not set! Please fill in manualConfig object.");
        }
        
        const app = initializeApp(finalConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = finalAppId;

        // --- State ---
        let currentUser = null;
        let participants = [];
        let isDrawing = false;
        const COLLECTION_NAME = 'participants';

        // --- DOM Elements ---
        const views = {
            reg: document.getElementById('registrationView'),
            admin: document.getElementById('adminView')
        };
        const form = document.getElementById('raffleForm');
        const successMsg = document.getElementById('successMessage');
        const tableBody = document.getElementById('participantTableBody');
        const countDisplay = document.getElementById('participantCount');
        const drawDisplay = document.getElementById('scrollingName');
        const drawBtn = document.getElementById('drawBtn');
        const statusEl = document.getElementById('connectionStatus');

        // --- Auth ---
        const initAuth = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch(e) {
                    console.warn("AI Token login failed, switching to anonymous.", e);
                    try {
                        await signInAnonymously(auth);
                    } catch (anonErr) {
                         console.error("Anonymous login failed", anonErr);
                         alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº« (ç™»å…¥å¤±æ•—)ã€‚è«‹æª¢æŸ¥ Firebase è¨­å®šæ˜¯å¦æ­£ç¢º (API Key)ã€‚\néŒ¯èª¤è¨Šæ¯: " + anonErr.message);
                         statusEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i> é€£ç·šå¤±æ•— (è¨­å®šéŒ¯èª¤)';
                         statusEl.className = "text-xs mt-2 text-red-300 font-bold";
                    }
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Anonymous login failed", e);
                    // åªæœ‰åœ¨ä¸æ˜¯ AI ç’°å¢ƒä¸‹æ‰è·³å‡ºé€™å€‹éŒ¯èª¤ï¼Œé¿å…å¹²æ“¾é è¦½
                    if (typeof __firebase_config === 'undefined') {
                        alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº« (ç™»å…¥å¤±æ•—)ã€‚\nè«‹æª¢æŸ¥æ‚¨çš„ 'manualConfig' æ˜¯å¦å·²æ­£ç¢ºå¡«å…¥ Firebase è³‡æ–™ã€‚\n\néŒ¯èª¤: " + e.message);
                    }
                    statusEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i> é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥è¨­å®š)';
                    statusEl.className = "text-xs mt-2 text-red-300 font-bold";
                }
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                statusEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-400"></i> ä¼ºæœå™¨é€£ç·šæˆåŠŸ';
                statusEl.className = "text-xs mt-2 text-green-300";
                setupRealtimeListener();
            }
        });

        // --- Firestore Logic ---
        function getCollectionRef() {
            // Using public data so host can see everyone's entries
            return collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
        }

        function setupRealtimeListener() {
            if (!currentUser) return;
            
            const q = query(getCollectionRef(), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                participants = [];
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    participants.push({ id: doc.id, ...data });
                    
                    // Render row (only if admin view is active or strictly updating data)
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-white hover:bg-opacity-10 transition-colors';
                    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    const phoneDisplay = data.phone.length > 3 ? '***' + data.phone.slice(-3) : data.phone;
                    
                    row.innerHTML = `
                        <td class="p-3 font-bold text-white">${escapeHtml(data.name)}</td>
                        <td class="p-3 text-gray-300">${escapeHtml(phoneDisplay)}</td>
                        <td class="p-3 text-gray-400 text-sm">${time}</td>
                    `;
                    tableBody.appendChild(row);
                });

                countDisplay.textContent = participants.length;
            }, (error) => {
                console.error("Error listening to data:", error);
                statusEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> è®€å–è³‡æ–™å¤±æ•— (æ¬Šé™/è¨­å®š)';
            });
        }

        // --- Registration Logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥
            if (!currentUser) {
                alert("å°šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. Firebase è¨­å®šæœ‰èª¤ (API Key)\n2. ç¶²è·¯é€£ç·šä¸ç©©\n\nè«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ manualConfig è¨­å®šï¼Œæˆ–é‡æ–°æ•´ç†ç¶²é ã€‚");
                return;
            }

            const nameInput = document.getElementById('guestName');
            const phoneInput = document.getElementById('guestPhone');
            const submitBtn = form.querySelector('button[type="submit"]');

            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();

            if (!name || !phone) return;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';

                await addDoc(getCollectionRef(), {
                    name: name,
                    phone: phone,
                    timestamp: Date.now(),
                    userId: currentUser.uid // Track who added it
                });

                // Show Success
                form.classList.add('hidden');
                successMsg.classList.remove('hidden');
                
                // Clear inputs
                nameInput.value = '';
                phoneInput.value = '';

            } catch (err) {
                console.error("Error adding document:", err);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•é€å‡ºè³‡æ–™ã€‚\n\nè«‹ç¢ºèªæ‚¨çš„ Firestore è³‡æ–™åº«è¦å‰‡æ˜¯å¦å…è¨±å¯«å…¥ï¼Œæˆ–æª¢æŸ¥ Firebase è¨­å®šã€‚\néŒ¯èª¤ä»£ç¢¼: " + err.code);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> ç¢ºèªé€å‡º';
            }
        });

        document.getElementById('registerAgainBtn').addEventListener('click', () => {
            successMsg.classList.add('hidden');
            form.classList.remove('hidden');
        });

        // --- Draw Logic (Admin) ---
        drawBtn.addEventListener('click', () => {
            if (participants.length === 0) {
                alert("ç›®å‰æ²’æœ‰åƒåŠ è€…ï¼");
                return;
            }
            if (isDrawing) return;

            isDrawing = true;
            drawBtn.disabled = true;
            drawDisplay.classList.add('rolling');
            drawDisplay.classList.remove('text-yellow-300', 'scale-125'); // Reset style
            drawDisplay.style.textShadow = 'none';

            let counter = 0;
            const maxIterations = 30; // How many shuffles before stopping
            
            // Rolling animation
            const interval = setInterval(() => {
                const randomIdx = Math.floor(Math.random() * participants.length);
                drawDisplay.textContent = participants[randomIdx].name;
                counter++;

                if (counter > maxIterations) {
                    clearInterval(interval);
                    finalizeWinner();
                }
            }, 100);
        });

        function finalizeWinner() {
            // Actually pick a winner
            const winnerIdx = Math.floor(Math.random() * participants.length);
            const winner = participants[winnerIdx];

            // Visual Stop
            drawDisplay.classList.remove('rolling');
            drawDisplay.textContent = winner.name;
            drawDisplay.classList.add('winner-animation', 'text-yellow-300');
            drawDisplay.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            
            // Confetti/Effects could go here
            createFireworks();

            isDrawing = false;
            drawBtn.disabled = false;
            drawBtn.innerHTML = '<span class="relative z-10"><i class="fa-solid fa-rotate-right"></i> å†æŠ½ä¸€ä½</span>';
        }

        function createFireworks() {
            // Simple visual effect placeholder
            const container = document.getElementById('drawDisplay');
            container.style.borderColor = '#fff';
            setTimeout(() => container.style.borderColor = '#fbbf24', 300);
            setTimeout(() => container.style.borderColor = '#fff', 600);
            setTimeout(() => container.style.borderColor = '#fbbf24', 900);
        }

        // --- Admin/UI Management ---
        window.resetData = async () => {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰åƒåŠ è€…åå–®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            
            try {
                const snapshot = await getDocs(getCollectionRef());
                const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);
                alert("å·²é‡ç½®æ‰€æœ‰è³‡æ–™ã€‚");
                drawDisplay.textContent = "æº–å‚™æŠ½ç";
                drawBtn.innerHTML = '<span class="relative z-10"><i class="fa-solid fa-star"></i> é–‹å§‹æŠ½ç</span>';
            } catch (err) {
                console.error("Reset failed", err);
                alert("é‡ç½®å¤±æ•—");
            }
        };

        window.exitAdmin = () => {
            views.admin.classList.add('hidden');
            views.reg.classList.remove('hidden');
            document.body.scrollIntoView({behavior: 'smooth'});
        };

        // --- Admin Password & QR Code ---
        const modal = document.getElementById('passwordModal');
        const passInput = document.getElementById('adminPassword');

        document.getElementById('adminToggleBtn').addEventListener('click', () => {
            modal.classList.remove('hidden');
            passInput.value = '';
            passInput.focus();
        });

        window.closePasswordModal = () => {
            modal.classList.add('hidden');
        };

        window.checkPassword = () => {
            if (passInput.value === '1225') {
                modal.classList.add('hidden');
                views.reg.classList.add('hidden');
                views.admin.classList.remove('hidden');
                generateQRCode();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ (æç¤º: è–èª•ç¯€æ—¥æœŸ)");
            }
        };

        // QR Code Generation
        let qrCodeObj = null;
        function generateQRCode() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous
            
            // Generate QR for the current URL
            const currentUrl = window.location.href;
            
            qrCodeObj = new QRCode(qrContainer, {
                text: currentUrl,
                width: 150,
                height: 150,
                colorDark : "#1a472a",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // Utility
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>