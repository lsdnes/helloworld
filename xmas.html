<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•æ­¡æ¨‚æ‘¸å½©æ´¾å° ğŸ…</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: radial-gradient(circle at center, #1a472a 0%, #0d2b18 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Snow effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            cursor: default;
            animation-name: snowflakes-fall, snowflakes-shake;
            animation-duration: 10s, 3s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
            animation-play-state: running, running;
        }
        
        @keyframes snowflakes-fall {
            0% { top: -10%; }
            100% { top: 100%; }
        }
        
        @keyframes snowflakes-shake {
            0% { transform: translateX(0px); }
            50% { transform: translateX(80px); }
            100% { transform: translateX(0px); }
        }

        .snowflake:nth-of-type(1) { left: 1%; animation-delay: 0s, 0s; }
        .snowflake:nth-of-type(2) { left: 10%; animation-delay: 1s, 1s; }
        .snowflake:nth-of-type(3) { left: 20%; animation-delay: 6s, 0.5s; }
        .snowflake:nth-of-type(4) { left: 30%; animation-delay: 4s, 2s; }
        .snowflake:nth-of-type(5) { left: 40%; animation-delay: 2s, 2s; }
        .snowflake:nth-of-type(6) { left: 50%; animation-delay: 8s, 3s; }
        .snowflake:nth-of-type(7) { left: 60%; animation-delay: 6s, 2s; }
        .snowflake:nth-of-type(8) { left: 70%; animation-delay: 2.5s, 1s; }
        .snowflake:nth-of-type(9) { left: 80%; animation-delay: 1s, 0s; }
        .snowflake:nth-of-type(10) { left: 90%; animation-delay: 3s, 1.5s; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-christmas {
            background: rgba(255, 255, 255, 0.9);
            color: #1a472a;
            border: 2px solid #c41e3a;
        }

        .btn-christmas {
            background: linear-gradient(to bottom, #d42426, #b3000c);
            border: 2px solid #ffd700;
            box-shadow: 0 4px 0 #8b0000;
            transition: all 0.1s;
        }
        .btn-christmas:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #8b0000;
        }

        .search-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #fbbf24;
            color: #fff;
            width: 100%;
            padding: 8px 12px 8px 36px;
            border-radius: 999px;
            outline: none;
            transition: all 0.3s;
        }
        .search-input:focus {
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.5);
        }

        .gold-text {
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .winner-animation {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        .rolling {
            animation: blurText 0.1s infinite;
        }

        @keyframes blurText {
            0% { filter: blur(0px); transform: translateY(0); }
            50% { filter: blur(2px); transform: translateY(-2px); }
            100% { filter: blur(0px); transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen relative pb-10">

    <!-- Snowflakes -->
    <div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div>
    <div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div>
    <div class="snowflake">â…</div><div class="snowflake">â†</div>

    <!-- Header -->
    <header class="w-full p-4 text-center z-10 relative mt-4">
        <h1 class="text-4xl md:text-6xl font-bold gold-text mb-2 drop-shadow-lg">
            <i class="fa-solid fa-tree text-green-400"></i> è–èª•æ­¡æ¨‚æ‘¸å½© <i class="fa-solid fa-gifts text-red-500"></i>
        </h1>
        <p class="text-lg text-gray-200">ç¥å¤§å®¶è–èª•å¿«æ¨‚ Merry Christmas</p>
    </header>

    <!-- Main Content Area -->
    <main class="w-full max-w-md md:max-w-2xl p-4 z-10 relative flex-grow">
        
        <!-- Registration View (Default) -->
        <div id="registrationView" class="w-full max-w-md mx-auto transition-all duration-300">
            
            <!-- Registration Form Area -->
            <div id="regFormContainer" class="glass-panel rounded-2xl p-6 md:p-8 mb-6">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-ticket text-5xl text-yellow-400 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">ç™»è¨˜åƒåŠ æŠ½ç</h2>
                    <p class="text-sm opacity-80">å¡«å¯«è³‡æ–™ï¼Œå°‡æœ‰æ©Ÿæœƒç²å¾—å¤§çï¼</p>
                    
                    <!-- Status Indicator -->
                    <div id="connectionStatus" class="mt-4 text-xs font-bold transition-all p-2 rounded">
                        <span class="text-yellow-300"><i class="fa-solid fa-circle-notch fa-spin"></i> æ­£åœ¨é€£ç·šåˆ°ä¼ºæœå™¨...</span>
                    </div>
                </div>

                <form id="raffleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1 ml-1">æ‚¨çš„å§“å / Name</label>
                        <input type="text" id="guestName" required placeholder="è«‹è¼¸å…¥å§“å" 
                            class="input-christmas w-full p-3 rounded-lg outline-none focus:ring-4 focus:ring-yellow-400">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1 ml-1">æ‰‹æ©Ÿè™Ÿç¢¼ / Phone</label>
                        <input type="tel" id="guestPhone" required placeholder="0912-345-678" 
                            oninput="this.value = this.value.replace(/[^0-9-]/g, '')"
                            class="input-christmas w-full p-3 rounded-lg outline-none focus:ring-4 focus:ring-yellow-400">
                        <p class="text-xs text-gray-300 mt-1 ml-1">* åªå¯è¼¸å…¥æ•¸å­—èˆ‡æ¸›è™Ÿ (-)</p>
                    </div>
                    <button type="submit" class="btn-christmas w-full py-4 rounded-lg text-xl font-bold mt-4 text-white">
                        <i class="fa-solid fa-paper-plane mr-2"></i> ç¢ºèªé€å‡º
                    </button>
                </form>

                <div id="successMessage" class="hidden text-center mt-6 p-4 bg-green-800 bg-opacity-80 rounded-lg border-2 border-green-400">
                    <i class="fa-solid fa-check-circle text-4xl text-green-300 mb-2"></i>
                    <h3 class="text-xl font-bold">ç™»è¨˜æˆåŠŸï¼</h3>
                    <p>è«‹ç•™æ„æ™šæœƒæŠ½çç’°ç¯€</p>
                    <button id="registerAgainBtn" class="mt-4 text-sm underline text-gray-300 hover:text-white">é‡æ–°ç™»è¨˜</button>
                </div>

                <!-- Registration Closed Message -->
                <div id="registrationClosedMsg" class="hidden text-center py-8">
                    <i class="fa-solid fa-lock text-5xl text-gray-400 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-200">å ±åå·²æˆªæ­¢</h3>
                    <p class="text-gray-400 mt-2">ä¸»æŒäººå·²é—œé–‰å ±åé€šé“ï¼Œè«‹é—œæ³¨ä¸‹æ–¹é–‹çåå–®ï¼</p>
                </div>
            </div>

             <!-- Detailed Error Box (Hidden by default) -->
             <div id="errorDetails" class="hidden mb-6 text-left p-3 bg-red-900/90 border border-red-400 rounded text-xs text-red-100">
                <h4 class="font-bold mb-1 text-white"><i class="fa-solid fa-bug"></i> è¨ºæ–·å ±å‘Šï¼š</h4>
                <p id="errorDetailsText">...</p>
            </div>

            <!-- Guest Winners List (Syncs with Admin) -->
            <div id="guestWinnersSection" class="glass-panel rounded-2xl p-6 border-2 border-yellow-500 bg-yellow-900 bg-opacity-30">
                <h3 class="text-xl font-bold mb-4 border-b border-yellow-500 pb-2 flex items-center justify-between">
                    <span><i class="fa-solid fa-trophy text-yellow-400 mr-2"></i> ä¸­çåå–®</span>
                    <span class="text-xs font-normal bg-yellow-600 px-2 py-1 rounded text-black">å³æ™‚æ›´æ–°</span>
                </h3>
                
                <!-- Guest Search Bar -->
                <div class="mb-4 relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-yellow-400"></i>
                    <input type="text" id="guestSearchInput" placeholder="æœå°‹å§“åæˆ–é›»è©±æœ«ä¸‰ç¢¼..." class="search-input">
                </div>

                <div class="overflow-y-auto max-h-60 custom-scrollbar">
                    <table class="w-full text-left">
                        <thead class="bg-black bg-opacity-30 text-yellow-400 text-sm">
                            <tr>
                                <th class="p-2">åºè™Ÿ</th>
                                <th class="p-2">å§“å</th>
                                <th class="p-2">æœ«ä¸‰ç¢¼</th>
                            </tr>
                        </thead>
                        <tbody id="guestWinnersTableBody" class="divide-y divide-yellow-800 text-yellow-100">
                            <!-- Winners injected here -->
                        </tbody>
                    </table>
                    <p id="guestNoWinnersMsg" class="text-center text-gray-400 py-6 text-sm italic hidden">
                        <i class="fa-solid fa-gift mb-2 text-2xl block"></i>
                        æŠ½çæº–å‚™ä¸­...
                    </p>
                    <p id="guestNoMatchMsg" class="text-center text-gray-400 py-6 text-sm italic hidden">
                        æŸ¥ç„¡ç¬¦åˆè³‡æ–™
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard View (Hidden by default) -->
        <div id="adminView" class="hidden w-full transition-all duration-300">
            <div class="glass-panel rounded-2xl p-6 md:p-8 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-500 pb-4">
                    <div>
                        <h2 class="text-3xl font-bold gold-text">å¾Œå°ç®¡ç†ä¸­å¿ƒ</h2>
                        <div class="flex gap-4 mt-2">
                            <p class="text-sm">åƒåŠ äººæ•¸: <span id="participantCount" class="text-xl font-bold text-white">0</span></p>
                            <p class="text-sm">ä¸­çäººæ•¸: <span id="winnerCount" class="text-xl font-bold text-green-400">0</span></p>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex flex-wrap gap-2 justify-center">
                        <!-- Toggle Registration Button -->
                        <button id="toggleRegBtn" onclick="toggleRegistration()" class="px-4 py-2 rounded text-sm font-bold border border-green-500 bg-green-700 hover:bg-green-600 transition-colors shadow-lg">
                            <i class="fa-solid fa-door-open"></i> é–‹æ”¾å ±åä¸­
                        </button>
                        
                        <button onclick="resetData()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm border border-gray-500">
                            <i class="fa-solid fa-trash-can"></i> é‡ç½®æ´»å‹•
                        </button>
                        <button onclick="exitAdmin()" class="bg-red-800 hover:bg-red-700 px-4 py-2 rounded text-sm border border-red-500">
                            <i class="fa-solid fa-sign-out-alt"></i> é›¢é–‹å¾Œå°
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- QR Code Section -->
                    <div class="bg-white bg-opacity-90 p-4 rounded-xl text-center text-gray-800 flex flex-col items-center justify-center">
                        <h3 class="font-bold text-lg mb-2 text-[#1a472a]">æƒæåŠ å…¥æŠ½ç</h3>
                        <div id="qrcode" class="border-4 border-[#c41e3a] p-2 bg-white rounded-lg"></div>
                        <p class="text-xs mt-2 text-gray-600">è«‹ä¾†è³“æƒææ­¤ QR Code</p>
                    </div>

                    <!-- Draw Control Section -->
                    <div class="flex flex-col justify-center items-center text-center">
                        <div id="drawDisplay" class="w-full h-40 bg-black bg-opacity-50 rounded-xl border-4 border-yellow-400 flex items-center justify-center mb-4 overflow-hidden relative p-4">
                            <div id="scrollingName" class="text-4xl font-bold text-white">æº–å‚™æŠ½ç</div>
                            <div id="fireworks" class="absolute inset-0 pointer-events-none"></div>
                        </div>
                        
                        <button id="drawBtn" class="btn-christmas w-full py-4 rounded-lg text-2xl font-bold text-white relative overflow-hidden group">
                            <span class="relative z-10"><i class="fa-solid fa-star"></i> é–‹å§‹æŠ½ç</span>
                            <div class="absolute top-0 left-0 w-full h-full bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Winners List Section (Admin) -->
            <div class="glass-panel rounded-2xl p-6 mb-6 border-2 border-yellow-500 bg-yellow-900 bg-opacity-30">
                <h3 class="text-xl font-bold mb-4 border-b border-yellow-500 pb-2 flex items-center">
                    <i class="fa-solid fa-trophy text-yellow-400 mr-2"></i> æ¦®è­½æ¦œ (ä¸­çåå–®)
                </h3>

                <!-- Admin Search Bar -->
                <div class="mb-4 relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-yellow-400"></i>
                    <input type="text" id="adminSearchInput" placeholder="æœå°‹å§“åæˆ–é›»è©±æœ«ä¸‰ç¢¼..." class="search-input">
                </div>

                <div class="overflow-y-auto max-h-48 custom-scrollbar">
                    <table class="w-full text-left">
                        <thead class="bg-black bg-opacity-30 text-yellow-400">
                            <tr>
                                <th class="p-3">åºè™Ÿ</th>
                                <th class="p-3">å§“å</th>
                                <th class="p-3">é›»è©± (æœ«ä¸‰ç¢¼)</th>
                                <th class="p-3">ä¸­çæ™‚é–“</th>
                                <th class="p-3">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="winnersTableBody" class="divide-y divide-yellow-800 text-yellow-100">
                            <!-- Winners will be injected here -->
                        </tbody>
                    </table>
                    <p id="noWinnersMsg" class="text-center text-gray-400 py-4 text-sm italic hidden">ç›®å‰å°šæœªç”¢ç”Ÿä¸­çè€…</p>
                    <p id="adminNoMatchMsg" class="text-center text-gray-400 py-4 text-sm italic hidden">æŸ¥ç„¡ç¬¦åˆè³‡æ–™</p>
                </div>
            </div>

            <!-- Participant List -->
            <div class="glass-panel rounded-2xl p-6 opacity-80">
                <h3 class="text-xl font-bold mb-4 border-b border-gray-500 pb-2">
                    <i class="fa-solid fa-users"></i> åƒåŠ è€…åå–®
                </h3>
                <div class="overflow-y-auto max-h-40 custom-scrollbar">
                    <table class="w-full text-left">
                        <thead class="bg-black bg-opacity-30 text-gray-300">
                            <tr>
                                <th class="p-3">å§“å</th>
                                <th class="p-3">é›»è©± (æœ«ä¸‰ç¢¼)</th>
                                <th class="p-3">ç™»è¨˜æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody id="participantTableBody" class="divide-y divide-gray-600">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer / Admin Toggle -->
    <footer class="w-full text-center p-4 z-10 text-sm text-gray-400">
        <p class="mb-2">Happy Holidays & Good Luck!</p>
        <button id="adminToggleBtn" class="opacity-30 hover:opacity-100 transition-opacity text-xs border border-gray-600 px-2 py-1 rounded">
            ğŸ… ä¸»æŒäººå¾Œå°
        </button>
    </footer>

    <!-- Admin Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center">
        <div class="bg-white text-gray-900 p-6 rounded-xl max-w-sm w-full mx-4 shadow-2xl border-4 border-[#1a472a]">
            <h3 class="text-xl font-bold mb-4 text-[#1a472a] text-center">è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼</h3>
            <input type="password" id="adminPassword" class="w-full border-2 border-gray-300 p-2 rounded mb-4 text-center text-lg" placeholder="Password">
            <div class="flex gap-2">
                <button onclick="closePasswordModal()" class="flex-1 bg-gray-300 py-2 rounded font-bold hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="checkPassword()" class="flex-1 bg-[#c41e3a] text-white py-2 rounded font-bold hover:bg-[#a01830]">é€²å…¥</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, getDocs, doc, where, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config & Init ---
        // âš ï¸ éƒ¨ç½²åˆ° GitHub Pages å‰çš„å¿…åšè¨­å®š / REQUIRED SETUP FOR GITHUB PAGES
        // ------------------------------------------------------------------
        // è«‹åˆ° Firebase Console (https://console.firebase.google.com/)
        // å»ºç«‹ä¸€å€‹å°ˆæ¡ˆï¼Œä¸¦è¤‡è£½ "Web App" çš„è¨­å®šè²¼åœ¨ä¸‹æ–¹ï¼š
        
        const manualConfig = {
            // è«‹å°‡ä¸‹æ–¹çš„å­—ä¸²æ›¿æ›ç‚ºæ‚¨çš„ Firebase å¯¦éš›è¨­å®š
            // Please replace the strings below with your actual Firebase config
            apiKey: "AIzaSyB4mNbRMkVAY-R5JSrF2O7fPN4dDry8alI",
            authDomain: "xmas-1654f.firebaseapp.com",
            projectId: "xmas-1654f",
            storageBucket: "xmas-1654f.firebasestorage.app",
            messagingSenderId: "171667807726",
            appId: "1:171667807726:web:485e64aa2ec736ef4f02ff",
            measurementId: "G-ZBN2J3BKLD"
        };

        // è‡ªå‹•åˆ¤æ–·ç’°å¢ƒï¼š
        let finalConfig;
        let finalAppId;

        try {
            if (typeof __firebase_config !== 'undefined') {
                finalConfig = JSON.parse(__firebase_config);
                finalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
            } else {
                finalConfig = manualConfig;
                finalAppId = 'christmas-raffle-v1'; // è‡ªè¨‚ App ID
            }
        } catch (e) {
            finalConfig = manualConfig;
            finalAppId = 'christmas-raffle-v1';
        }

        // --- DOM Elements ---
        const views = {
            reg: document.getElementById('registrationView'),
            admin: document.getElementById('adminView')
        };
        const form = document.getElementById('raffleForm');
        const regFormContainer = document.getElementById('regFormContainer');
        const regClosedMsg = document.getElementById('registrationClosedMsg');
        const successMsg = document.getElementById('successMessage');
        const tableBody = document.getElementById('participantTableBody');
        const winnersTableBody = document.getElementById('winnersTableBody');
        const guestWinnersTableBody = document.getElementById('guestWinnersTableBody');
        const countDisplay = document.getElementById('participantCount');
        const winnerCountDisplay = document.getElementById('winnerCount');
        const drawDisplay = document.getElementById('scrollingName');
        const drawBtn = document.getElementById('drawBtn');
        const toggleRegBtn = document.getElementById('toggleRegBtn');
        const statusEl = document.getElementById('connectionStatus');
        const errorDetails = document.getElementById('errorDetails');
        const errorDetailsText = document.getElementById('errorDetailsText');
        
        const noWinnersMsg = document.getElementById('noWinnersMsg');
        const adminNoMatchMsg = document.getElementById('adminNoMatchMsg');
        const guestNoWinnersMsg = document.getElementById('guestNoWinnersMsg');
        const guestNoMatchMsg = document.getElementById('guestNoMatchMsg');
        
        const adminSearchInput = document.getElementById('adminSearchInput');
        const guestSearchInput = document.getElementById('guestSearchInput');

        // Helper for showing errors
        function showError(message, technicalDetail = "") {
            statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-circle-xmark"></i> é€£ç·šç™¼ç”ŸéŒ¯èª¤</span>';
            errorDetails.classList.remove('hidden');
            errorDetailsText.innerText = message + (technicalDetail ? "\n\n(æŠ€è¡“ä»£ç¢¼: " + technicalDetail + ")" : "");
        }

        // æª¢æŸ¥ Config ç‹€æ…‹
        let app, auth, db, appId;
        
        if (typeof __firebase_config === 'undefined' && finalConfig.apiKey.includes("æ›¿æ›æˆæ‚¨çš„")) {
            showError("Firebase è¨­å®šæœªå¡«å¯«ï¼", "è«‹ç”¨æ–‡å­—ç·¨è¼¯å™¨é–‹å•Ÿæª”æ¡ˆï¼Œä¿®æ”¹ 'manualConfig' å€å¡Šã€‚");
        } else {
            try {
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = finalAppId;
            } catch (e) {
                showError("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config æ ¼å¼ã€‚", e.message);
            }
        }

        // --- State ---
        let currentUser = null;
        let participants = [];
        let winners = [];
        let isDrawing = false;
        let isRegistrationOpen = true;

        const COLLECTION_NAME = 'participants';
        const WINNERS_COLLECTION_NAME = 'winners';
        const SETTINGS_COLLECTION_NAME = 'app_settings';

        // --- Auth ---
        const initAuth = async () => {
            if (!auth) return;

             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch(e) {
                    console.warn("Token login failed, switching to anonymous.", e);
                    attemptAnonymousLogin();
                }
            } else {
                attemptAnonymousLogin();
            }
        };

        const attemptAnonymousLogin = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth failed", e);
                let userMsg = "ç„¡æ³•ç™»å…¥è³‡æ–™åº«ã€‚";
                // è©³ç´°éŒ¯èª¤ä»£ç¢¼åˆ¤æ–·
                if (e.code === 'auth/operation-not-allowed') {
                    userMsg = "è«‹è‡³ Firebase Console > Authentication > Sign-in method \nå°‡ 'Anonymous' (åŒ¿å) è¨­ç‚ºå•Ÿç”¨ã€‚";
                } else if (e.code === 'auth/configuration-not-found') {
                    userMsg = "Authentication æœå‹™å°šæœªå•Ÿç”¨ã€‚\nè«‹è‡³ Firebase Console é»æ“Š Authentication ä¸¦æŒ‰ä¸‹ 'Get Started' (é–‹å§‹ä½¿ç”¨)ã€‚";
                } else if (e.code === 'auth/api-key-not-valid') {
                    userMsg = "API Key ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ manualConfig è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚";
                }
                showError(userMsg, e.code);
            }
        };

        if (auth) initAuth();

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    statusEl.innerHTML = '<span class="text-green-300"><i class="fa-solid fa-circle-check"></i> ä¼ºæœå™¨é€£ç·šæˆåŠŸ</span>';
                    errorDetails.classList.add('hidden'); // Hide error box if success
                    setupRealtimeListeners();
                }
            });
        }

        // --- Firestore Logic ---
        function getCollectionRef(name) {
            return collection(db, 'artifacts', appId, 'public', 'data', name);
        }

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // 1. Listen for Participants
            const qParticipants = query(getCollectionRef(COLLECTION_NAME), orderBy('timestamp', 'desc'));
            onSnapshot(qParticipants, (snapshot) => {
                participants = [];
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    participants.push({ id: doc.id, ...data });
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-white hover:bg-opacity-10 transition-colors';
                    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    const phoneDisplay = data.phone.length > 3 ? '***' + data.phone.slice(-3) : data.phone;
                    
                    row.innerHTML = `
                        <td class="p-3 font-bold text-white">${escapeHtml(data.name)}</td>
                        <td class="p-3 text-gray-300">${escapeHtml(phoneDisplay)}</td>
                        <td class="p-3 text-gray-400 text-sm">${time}</td>
                    `;
                    tableBody.appendChild(row);
                });
                countDisplay.textContent = participants.length;
            }, (error) => {
                console.error("Error listening to participants:", error);
            });

            // 2. Listen for Winners (Store in memory, Render by function)
            const qWinners = query(getCollectionRef(WINNERS_COLLECTION_NAME), orderBy('timestamp', 'asc')); 
            onSnapshot(qWinners, (snapshot) => {
                winners = [];
                snapshot.forEach(doc => {
                    winners.push({ id: doc.id, ...doc.data() });
                });
                winnerCountDisplay.textContent = winners.length;
                
                // Re-render both tables
                renderAllWinnerTables();
                
            }, (error) => {
                console.error("Error listening to winners:", error);
            });

            // 3. Listen for Settings (Registration Status)
            const settingsDocRef = doc(getCollectionRef(SETTINGS_COLLECTION_NAME), 'config');
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    isRegistrationOpen = docSnap.data().isOpen;
                } else {
                    // Default to open if no setting exists
                    isRegistrationOpen = true; 
                }
                updateRegistrationUI();
            });
        }

        // --- Render Functions (with Search Filter) ---
        
        function renderAllWinnerTables() {
            const adminTerm = adminSearchInput.value.trim().toLowerCase();
            const guestTerm = guestSearchInput.value.trim().toLowerCase();
            
            renderAdminWinnersTable(adminTerm);
            renderGuestWinnersTable(guestTerm);
        }

        function filterWinners(term) {
            if (!term) return winners;
            return winners.filter(w => {
                const nameMatch = w.name.toLowerCase().includes(term);
                const phoneMatch = w.phone.includes(term); // Phone stored as clean digits
                return nameMatch || phoneMatch;
            });
        }

        function renderAdminWinnersTable(searchTerm) {
            const filteredWinners = filterWinners(searchTerm);
            winnersTableBody.innerHTML = '';
            
            if (winners.length === 0) {
                noWinnersMsg.classList.remove('hidden');
                adminNoMatchMsg.classList.add('hidden');
            } else if (filteredWinners.length === 0) {
                noWinnersMsg.classList.add('hidden');
                adminNoMatchMsg.classList.remove('hidden');
            } else {
                noWinnersMsg.classList.add('hidden');
                adminNoMatchMsg.classList.add('hidden');
                
                filteredWinners.forEach(data => {
                    // Use winnerRank from data, fallback to index calculation if not strictly reliable client-side order needed
                    // But we ordered by timestamp in query, so array index matches rank logic if filter is OFF.
                    // If filter is ON, we should probably show their ORIGINAL rank.
                    const rank = data.winnerRank || '?';
                    
                    const phoneDisplay = data.phone.length > 3 ? '***' + data.phone.slice(-3) : data.phone;
                    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    const isClaimed = data.claimed || false;

                    const row = document.createElement('tr');
                    row.className = 'bg-yellow-900 bg-opacity-20 hover:bg-opacity-40 transition-colors border-b border-yellow-800';
                    const rankHtml = rank <= 3 
                        ? `<span class="inline-block w-8 h-8 rounded-full bg-yellow-500 text-black font-bold flex items-center justify-center">${rank}</span>` 
                        : `<span class="text-gray-300 pl-2">#${rank}</span>`;
                    
                    const claimBtnClass = isClaimed 
                        ? "bg-gray-600 hover:bg-gray-500 text-gray-300" 
                        : "bg-red-600 hover:bg-red-500 text-white animate-pulse";
                    const claimBtnText = isClaimed ? "å·²é ˜" : "æœªé ˜";
                    const adminNameClass = isClaimed ? "text-gray-500" : "text-yellow-200";

                    row.innerHTML = `
                        <td class="p-3">${rankHtml}</td>
                        <td class="p-3 font-bold text-lg ${adminNameClass}">
                            ${escapeHtml(data.name)}
                        </td>
                        <td class="p-3 font-mono">${escapeHtml(phoneDisplay)}</td>
                        <td class="p-3 text-xs text-yellow-500 opacity-70">${time}</td>
                        <td class="p-3">
                            <button onclick="toggleClaimStatus('${data.id}', ${isClaimed})" class="text-xs px-2 py-1 rounded ${claimBtnClass} font-bold border border-gray-500">
                                ${claimBtnText}
                            </button>
                        </td>
                    `;
                    winnersTableBody.appendChild(row);
                });
            }
        }

        function renderGuestWinnersTable(searchTerm) {
            const filteredWinners = filterWinners(searchTerm);
            guestWinnersTableBody.innerHTML = '';
            
            if (winners.length === 0) {
                guestNoWinnersMsg.classList.remove('hidden');
                guestNoMatchMsg.classList.add('hidden');
            } else if (filteredWinners.length === 0) {
                guestNoWinnersMsg.classList.add('hidden');
                guestNoMatchMsg.classList.remove('hidden');
            } else {
                guestNoWinnersMsg.classList.add('hidden');
                guestNoMatchMsg.classList.add('hidden');
                
                filteredWinners.forEach(data => {
                    const rank = data.winnerRank || '?';
                    const phoneDisplay = data.phone.length > 3 ? '***' + data.phone.slice(-3) : data.phone;
                    const isClaimed = data.claimed || false;
                    const guestNameClass = isClaimed ? "text-gray-500" : "text-yellow-300";

                    const row = document.createElement('tr');
                    row.className = 'border-b border-yellow-800 hover:bg-yellow-800 hover:bg-opacity-30';
                    const rankHtml = rank <= 3 
                        ? `<span class="inline-block w-8 h-8 rounded-full bg-yellow-500 text-black font-bold flex items-center justify-center">${rank}</span>` 
                        : `<span class="text-gray-300 pl-2">#${rank}</span>`;

                    row.innerHTML = `
                        <td class="p-2">${rankHtml}</td>
                        <td class="p-2 font-bold ${guestNameClass}">
                            ${escapeHtml(data.name)}
                        </td>
                        <td class="p-2 font-mono text-gray-300">${escapeHtml(phoneDisplay)}</td>
                    `;
                    guestWinnersTableBody.appendChild(row);
                });
            }
        }

        // Attach input listeners
        adminSearchInput.addEventListener('input', () => renderAdminWinnersTable(adminSearchInput.value.trim().toLowerCase()));
        guestSearchInput.addEventListener('input', () => renderGuestWinnersTable(guestSearchInput.value.trim().toLowerCase()));


        // --- UI Updates ---
        function updateRegistrationUI() {
            // Update Guest View
            if (isRegistrationOpen) {
                form.classList.remove('hidden');
                regClosedMsg.classList.add('hidden');
                if (successMsg.classList.contains('hidden')) {
                    // Only show form if success msg is hidden (user hasn't just registered)
                    form.style.display = 'block';
                }
            } else {
                form.classList.add('hidden');
                form.style.display = 'none'; // Ensure hidden
                // Don't hide success message if they just registered, but hide form area
                if (!successMsg.classList.contains('hidden')) {
                     // If success msg is showing, keep it, but ensure 'register again' is handled?
                     // Actually, if closed, we can just show the closed message below or replace.
                     // Let's just hide form.
                } else {
                     regClosedMsg.classList.remove('hidden');
                }
            }

            // Update Admin Button
            if (isRegistrationOpen) {
                toggleRegBtn.innerHTML = '<i class="fa-solid fa-door-open"></i> é–‹æ”¾å ±åä¸­';
                toggleRegBtn.className = "px-4 py-2 rounded text-sm font-bold border border-green-500 bg-green-700 hover:bg-green-600 transition-colors shadow-lg";
            } else {
                toggleRegBtn.innerHTML = '<i class="fa-solid fa-door-closed"></i> å·²åœæ­¢å ±å';
                toggleRegBtn.className = "px-4 py-2 rounded text-sm font-bold border border-red-500 bg-red-800 hover:bg-red-700 transition-colors shadow-lg";
            }
        }

        // --- Registration Logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert("å°šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼è«‹æŸ¥çœ‹ä¸Šæ–¹çš„éŒ¯èª¤è¨ºæ–·è¨Šæ¯ã€‚");
                return;
            }

            if (!isRegistrationOpen) {
                alert("å ±åå·²ç¶“æˆªæ­¢å›‰ï¼");
                window.location.reload(); // Refresh to update UI
                return;
            }

            const nameInput = document.getElementById('guestName');
            const phoneInput = document.getElementById('guestPhone');
            const submitBtn = form.querySelector('button[type="submit"]');

            const name = nameInput.value.trim();
            const rawPhone = phoneInput.value.trim();
            const cleanPhone = rawPhone.replace(/[^0-9]/g, '');

            if (!name || !cleanPhone) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å§“åèˆ‡é›»è©±");
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æª¢æŸ¥ä¸­...';

                // Check Duplicates
                const q = query(getCollectionRef(COLLECTION_NAME), where("phone", "==", cleanPhone));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    alert("é€™å€‹é›»è©±è™Ÿç¢¼å·²ç¶“ç™»è¨˜éäº†å–”ï¼\nè«‹å‹¿é‡è¦†å ±åã€‚");
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> ç¢ºèªé€å‡º';
                    return; 
                }

                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';

                await addDoc(getCollectionRef(COLLECTION_NAME), {
                    name: name,
                    phone: cleanPhone, 
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });

                form.classList.add('hidden');
                successMsg.classList.remove('hidden');
                nameInput.value = '';
                phoneInput.value = '';

            } catch (err) {
                console.error("Error adding document:", err);
                if (err.code === 'permission-denied') {
                    alert("å¯«å…¥å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Rulesã€‚");
                } else {
                    alert("ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> ç¢ºèªé€å‡º';
            }
        });

        document.getElementById('registerAgainBtn').addEventListener('click', () => {
            if (!isRegistrationOpen) {
                alert("ç›®å‰å ±åå·²æˆªæ­¢");
                return;
            }
            successMsg.classList.add('hidden');
            form.classList.remove('hidden');
            form.style.display = 'block';
        });

        // --- Admin Actions ---
        window.toggleRegistration = async () => {
            if (!currentUser) return;
            const newState = !isRegistrationOpen;
            const confirmMsg = newState ? "ç¢ºå®šè¦ã€é–‹æ”¾å ±åã€‘å—ï¼Ÿ" : "ç¢ºå®šè¦ã€åœæ­¢å ±åã€‘å—ï¼Ÿ\nåœæ­¢å¾Œï¼ŒåƒåŠ è€…å°‡ç„¡æ³•å†é€å‡ºè³‡æ–™ã€‚";
            
            if (!confirm(confirmMsg)) return;

            try {
                const settingsDocRef = doc(getCollectionRef(SETTINGS_COLLECTION_NAME), 'config');
                await setDoc(settingsDocRef, { isOpen: newState }, { merge: true });
                // UI will update automatically via listener
            } catch (err) {
                console.error("Error toggling settings:", err);
                alert("è¨­å®šå¤±æ•—: " + err.message);
            }
        };

        window.toggleClaimStatus = async (docId, currentStatus) => {
            if (!currentUser) return;
            // No confirm needed for quick toggle, or maybe yes? Let's skip confirm for speed, user can toggle back.
            try {
                const winnerRef = doc(getCollectionRef(WINNERS_COLLECTION_NAME), docId);
                await updateDoc(winnerRef, { claimed: !currentStatus });
            } catch (err) {
                console.error("Error toggling claim status:", err);
                alert("æ›´æ–°ç‹€æ…‹å¤±æ•—: " + err.message);
            }
        };

        // --- Draw Logic (Admin) ---
        drawBtn.addEventListener('click', () => {
            // Filter out existing winners from the draw pool
            const eligibleParticipants = participants.filter(p => {
                return !winners.some(w => w.phone === p.phone);
            });

            if (eligibleParticipants.length === 0) {
                if (participants.length > 0) {
                    alert("æ‰€æœ‰åƒåŠ è€…éƒ½å·²ç¶“ä¸­çäº†ï¼æ­å–œï¼");
                } else {
                    alert("ç›®å‰æ²’æœ‰åƒåŠ è€…ï¼");
                }
                return;
            }

            if (isDrawing) return;

            // Feature: Auto-close registration on draw start
            if (isRegistrationOpen) {
                const settingsDocRef = doc(getCollectionRef(SETTINGS_COLLECTION_NAME), 'config');
                setDoc(settingsDocRef, { isOpen: false }, { merge: true })
                    .then(() => console.log("Registration auto-closed due to draw start."))
                    .catch(err => console.error("Error auto-closing registration:", err));
            }

            isDrawing = true;
            drawBtn.disabled = true;
            drawDisplay.classList.add('rolling');
            drawDisplay.classList.remove('text-yellow-300', 'scale-125'); 
            drawDisplay.style.textShadow = 'none';
            drawDisplay.innerHTML = '<span class="text-4xl font-bold text-white">æº–å‚™æŠ½ç</span>'; 

            let counter = 0;
            const maxIterations = 30; 
            
            const interval = setInterval(() => {
                const randomIdx = Math.floor(Math.random() * eligibleParticipants.length);
                drawDisplay.textContent = eligibleParticipants[randomIdx].name;
                counter++;

                if (counter > maxIterations) {
                    clearInterval(interval);
                    finalizeWinner(eligibleParticipants);
                }
            }, 100);
        });

        async function finalizeWinner(eligiblePool) {
            const winnerIdx = Math.floor(Math.random() * eligiblePool.length);
            const winner = eligiblePool[winnerIdx];
            const phoneLast3 = winner.phone.length > 3 ? winner.phone.slice(-3) : winner.phone;

            drawDisplay.classList.remove('rolling');
            
            drawDisplay.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="text-4xl md:text-5xl mb-2">${escapeHtml(winner.name)}</div>
                    <div class="text-2xl md:text-3xl text-yellow-300 font-mono bg-black bg-opacity-30 px-3 py-1 rounded">
                        (æœ«ä¸‰ç¢¼: ${escapeHtml(phoneLast3)})
                    </div>
                </div>
            `;
            
            drawDisplay.classList.add('winner-animation', 'text-yellow-300');
            drawDisplay.style.textShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';
            
            createFireworks();

            try {
                await addDoc(getCollectionRef(WINNERS_COLLECTION_NAME), {
                    name: winner.name,
                    phone: winner.phone,
                    originalId: winner.id, 
                    timestamp: Date.now(),
                    winnerRank: winners.length + 1,
                    claimed: false // Default not claimed
                });
            } catch (err) {
                console.error("Error saving winner:", err);
                alert("å„²å­˜ä¸­çè€…è³‡æ–™å¤±æ•—ï¼è«‹æ‰‹å‹•è¨˜éŒ„ï¼");
            }

            isDrawing = false;
            drawBtn.disabled = false;
            drawBtn.innerHTML = '<span class="relative z-10"><i class="fa-solid fa-rotate-right"></i> å†æŠ½ä¸€ä½</span>';
        }

        function createFireworks() {
            const container = document.getElementById('drawDisplay');
            container.style.borderColor = '#fff';
            setTimeout(() => container.style.borderColor = '#fbbf24', 300);
            setTimeout(() => container.style.borderColor = '#fff', 600);
            setTimeout(() => container.style.borderColor = '#fbbf24', 900);
        }

        // --- Admin/UI Management ---
        window.resetData = async () => {
            if (!confirm("ç¢ºå®šè¦ã€é‡ç½®æ´»å‹•ã€‘å—ï¼Ÿ\n\nè­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰ã€ŒåƒåŠ è€…ã€åŠã€Œä¸­çåå–®ã€ï¼Œä¸¦é‡ç½®å ±åç‹€æ…‹ï¼æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            
            const btn = document.querySelector('button[onclick="resetData()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> åˆªé™¤ä¸­...';
            btn.disabled = true;

            try {
                // Delete Participants
                const snapshotP = await getDocs(getCollectionRef(COLLECTION_NAME));
                const deletePromisesP = snapshotP.docs.map(d => deleteDoc(d.ref));
                
                // Delete Winners
                const snapshotW = await getDocs(getCollectionRef(WINNERS_COLLECTION_NAME));
                const deletePromisesW = snapshotW.docs.map(d => deleteDoc(d.ref));

                // Reset Settings to Open
                const settingsDocRef = doc(getCollectionRef(SETTINGS_COLLECTION_NAME), 'config');
                const resetSettingsPromise = setDoc(settingsDocRef, { isOpen: true });

                await Promise.all([...deletePromisesP, ...deletePromisesW, resetSettingsPromise]);
                
                alert("å·²é‡ç½®æ‰€æœ‰è³‡æ–™ (åƒåŠ è€… & ä¸­çè€…)ï¼Œå ±åå·²é‡æ–°é–‹æ”¾ã€‚");
                drawDisplay.innerHTML = '<span class="text-4xl font-bold text-white">æº–å‚™æŠ½ç</span>';
                drawBtn.innerHTML = '<span class="relative z-10"><i class="fa-solid fa-star"></i> é–‹å§‹æŠ½ç</span>';
            } catch (err) {
                console.error("Reset failed", err);
                alert("é‡ç½®å¤±æ•—: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.exitAdmin = () => {
            views.admin.classList.add('hidden');
            views.reg.classList.remove('hidden');
            document.body.scrollIntoView({behavior: 'smooth'});
        };

        // --- Admin Password & QR Code ---
        const modal = document.getElementById('passwordModal');
        const passInput = document.getElementById('adminPassword');

        document.getElementById('adminToggleBtn').addEventListener('click', () => {
            modal.classList.remove('hidden');
            passInput.value = '';
            passInput.focus();
        });

        window.closePasswordModal = () => {
            modal.classList.add('hidden');
        };

        window.checkPassword = () => {
            if (passInput.value === '0514') {
                modal.classList.add('hidden');
                views.reg.classList.add('hidden');
                views.admin.classList.remove('hidden');
                generateQRCode();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
            }
        };

        // QR Code Generation
        let qrCodeObj = null;
        function generateQRCode() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous
            
            // Generate QR for the current URL
            const currentUrl = window.location.href;
            
            qrCodeObj = new QRCode(qrContainer, {
                text: currentUrl,
                width: 150,
                height: 150,
                colorDark : "#1a472a",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // Utility
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>